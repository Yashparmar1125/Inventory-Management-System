<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Inventory Management System</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #5E50F9; 
            --primary-color-rgb: 94, 80, 249;
            --secondary-color: #4A40C4;
            --success-color: #06d6a0;
            --danger-color: #ef476f;
            --warning-color: #ffd60a;
            --dark-color: #0b0f14; 
            --dark-surface: #0f172a; 
            --dark-border: #1f2937;
            
            --bs-primary: var(--primary-color);
            --bs-primary-rgb: var(--primary-color-rgb);

            --bs-border-radius: 0.5rem; 
            --bs-border-radius-lg: 0.75rem; 
            --bs-border-radius-xl: 1rem; 
            --bs-box-shadow-sm: 0 2px 4px rgba(0,0,0,0.04);
            --bs-box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --bs-box-shadow-lg: 0 10px 30px rgba(0,0,0,0.1);
            
            --bs-modal-border-radius: var(--bs-border-radius-lg);
            --bs-card-border-radius: var(--bs-border-radius-lg);
            --bs-card-border-width: 0;
            --bs-card-box-shadow: var(--bs-box-shadow);
        }

        body {
            background-color: #f9faff; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        /* --- Navbar --- */
        .navbar {
            background: #fff;
            box-shadow: none;
            border-bottom: 1px solid var(--bs-border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .navbar.scrolled { 
            box-shadow: var(--bs-box-shadow); 
            border-bottom-color: transparent; 
            backdrop-filter: saturate(180%) blur(6px);
        }
        .navbar-brand {
            font-weight: 700;
            color: var(--primary-color);
        }
        .navbar-brand i {
            font-size: 1.5rem;
            margin-right: 0.25rem;
        }
        /* Ensure dark mode navbar links are visible */
        .navbar-dark .navbar-nav .nav-link { 
             color: rgba(255, 255, 255, 0.75); 
        }
        .navbar-dark .navbar-nav .nav-link:hover, 
        .navbar-dark .navbar-nav .nav-link:focus { 
             color: rgba(255, 255, 255, 1); 
        }
        .navbar-dark .dropdown-menu { background-color: var(--dark-surface); border-color: var(--dark-border); }
        .navbar-dark .dropdown-item { color: #e5e7eb; }
        .navbar-dark .dropdown-item:hover, .navbar-dark .dropdown-item:focus { background-color: rgba(138, 180, 248, 0.1); color: #fff; }


        /* --- Sidebar --- */
        .sidebar {
            min-height: calc(100vh - 57px); /* Adjusted for 1px border */
            background-color: #fff;
            border-right: 1px solid var(--bs-border-color);
            padding: 1rem;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .sidebar .nav-link {
            color: #495057;
            padding: 10px 15px; 
            margin: 4px 0; 
            border-radius: var(--bs-border-radius);
            font-weight: 500; 
            transition: all 0.2s ease-out;
            display: flex; /* Align icon and text */
            align-items: center;
        }
        .sidebar .nav-link:hover {
            background-color: var(--bs-primary-bg-subtle);
            color: var(--primary-color);
            transform: translateX(3px);
        }
        .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(var(--primary-color-rgb), 0.3);
        }
        .sidebar .nav-link i {
            margin-right: 12px; 
            width: 20px;
            font-size: 1.1rem;
            text-align: center;
        }

        /* --- Content Area --- */
        .content-area {
            padding: 2rem; 
            background-color: #f9faff;
            transition: background-color 0.3s ease;
        }
        
        .page-section {
             display: none; /* Hide all sections initially */
             animation: fadeIn 0.5s ease-out; /* Add fade-in animation */
        }
        .page-section.active {
             display: block; /* Show active section */
        }
        @keyframes fadeIn {
             from { opacity: 0; transform: translateY(10px); }
             to { opacity: 1; transform: translateY(0); }
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .page-header h2 {
            margin-bottom: 0;
            font-weight: 700;
        }

        /* --- Stat Cards --- */
        .stat-card {
            border-radius: var(--bs-border-radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--bs-box-shadow);
            transition: all 0.3s ease;
            border: 0; 
            cursor: pointer; /* ADDED: Indicate clickable */
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--bs-box-shadow-lg);
        }
        .stat-card .fs-1 { font-size: 2.5rem !important; }
        .stat-card h3 { font-weight: 700; }

        /* --- Table Container --- */
        .table-container {
            background: white;
            border-radius: var(--bs-border-radius-lg);
            padding: 1.5rem; /* Adjusted padding */
            box-shadow: var(--bs-box-shadow);
            margin-bottom: 20px;
            overflow-x: auto;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        table thead th {
            position: sticky;
            top: 0;
            z-index: 1;
            background: #fff; 
            border-bottom: 2px solid #dee2e6;
            text-transform: none; 
            font-size: 0.85rem;
            font-weight: 600; 
            letter-spacing: 0.2px;
            color: #6c757d;
            padding: 1rem;
            vertical-align: middle;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        table tbody tr {
            border-bottom: 1px solid var(--bs-border-color);
            transition: background-color 0.15s ease-out;
        }
        table tbody tr:last-child {
            border-bottom: 0;
        }
        table tbody tr:hover {
            background-color: var(--bs-primary-bg-subtle);
        }
        table th, table td {
            padding: 1rem; 
            vertical-align: middle;
        }
        /* Table Action Buttons */
        table .btn-sm {
             padding: 0.25rem 0.5rem;
             font-size: 0.9rem; /* Slightly larger icon */
        }
        table .btn {
            margin: 0 2px;
        }
        .table-sm th, .table-sm td {
            padding: 0.75rem;
        }
        
        /* --- Responsive Tweaks --- */
        @media (max-width: 991.98px) {
            .content-area { padding: 1rem; }
            .page-header { flex-wrap: wrap; gap: .75rem; }
            .table-container { padding: 1rem; }

            /* Off-canvas sidebar */
            .sidebar {
                position: fixed;
                top: 57px;
                left: 0;
                height: calc(100vh - 57px);
                width: 260px;
                z-index: 1040;
                background-color: #fff;
                transform: translateX(-100%);
                box-shadow: var(--bs-box-shadow-lg);
                transition: transform .3s ease;
            }
            .sidebar.open { transform: translateX(0); }
            .content-area { margin-left: 0 !important; }
        }
        @media (max-width: 575.98px) {
            table th, table td { padding: .75rem .5rem; }
            .stat-card .fs-1 { font-size: 2rem !important; }
        }
        
        /* --- Buttons --- */
        .btn {
            border-radius: var(--bs-border-radius);
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .btn:focus-visible { 
            outline: 0; 
            box-shadow: 0 0 0 0.25rem rgba(var(--primary-color-rgb), 0.35);
        }
        .btn-primary {
            box-shadow: 0 2px 6px rgba(var(--primary-color-rgb), 0.3);
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            box-shadow: 0 4px 10px rgba(var(--primary-color-rgb), 0.4);
            transform: translateY(-1px);
        }
        /* Report buttons active state */
        #reports-section .btn.active {
             background-color: var(--primary-color);
             color: white;
             box-shadow: 0 2px 6px rgba(var(--primary-color-rgb), 0.3);
        }
        
        /* --- Forms --- */
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(var(--primary-color-rgb), 0.25);
            border-color: var(--primary-color);
        }
        .form-control:focus-visible, .form-select:focus-visible {
            outline: none;
        }
        .form-floating > .form-control,
        .form-floating > .form-select {
            border-radius: var(--bs-border-radius);
        }
        .form-control, .form-select {
            border-radius: var(--bs-border-radius);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        
        /* --- Modals --- */
        .modal-content {
            border: 0;
            box-shadow: var(--bs-box-shadow-lg);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .modal-header {
            border-bottom: 0;
            padding: 1.5rem 1.5rem 0; 
        }
        .modal-header .modal-title { font-weight: 600; }
        .modal-body {
            padding: 1.5rem;
        }
        .modal-footer {
            border-top: 0;
            padding: 0 1.5rem 1.5rem; 
        }

        /* --- Skeletons & Loaders --- */
        /* REMOVED: #loadingOverlay styles as it's no longer used globally */
        .loader { display: flex; gap: 10px; margin: 2rem auto; justify-content: center; } /* Center if used standalone */
        .loader .dot {
            width: 15px; height: 15px; border-radius: 50%;
            background-color: var(--primary-color);
            animation: bounce 0.6s infinite alternate;
        }
        .loader .dot:nth-child(2) { animation-delay: 0.2s; }
        .loader .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e6e6e6 37%, #f0f0f0 63%);
            background-size: 400% 100%;
            animation: shimmer 1.4s ease infinite;
            border-radius: 4px;
            min-height: 14px; /* Use min-height */
            width: 100%; /* Ensure full width */
            display: inline-block;
        }
        .skeleton.w-75 { width: 75% !important; }
        .skeleton.w-50 { width: 50% !important; }
        .skeleton.w-25 { width: 25% !important; }
        @keyframes shimmer {
            0% { background-position: 100% 0; }
            100% { background-position: -100% 0; } /* Adjusted for smoother loop */
        }

        /* --- Toast --- */
        .toast { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* --- Dark Mode --- */
        body[data-theme="dark"] {
            --primary-color: #8ab4f8;
            --primary-color-rgb: 138, 180, 248;
            --secondary-color: #669df6;
            --success-color: #2dd4bf;
            --danger-color: #f87171;
            --warning-color: #fbbf24;
            
            background-color: var(--dark-color);
            color: #e5e7eb;

            --bs-body-color: #e5e7eb;
            --bs-body-bg: var(--dark-color);
            --bs-emphasis-color: #fff;
            --bs-secondary-color: rgba(229, 231, 235, 0.75);
            --bs-secondary-bg: var(--dark-surface);
            --bs-tertiary-color: rgba(229, 231, 235, 0.5);
            --bs-tertiary-bg: #1f2937;
            --bs-border-color: var(--dark-border);
            --bs-border-color-translucent: rgba(255, 255, 255, 0.15);
            --bs-heading-color: #fff;

             /* Dark Form Controls */
             --bs-form-control-bg: var(--dark-surface);
             --bs-form-select-bg: var(--dark-surface);
             --bs-input-group-addon-bg: var(--dark-surface);
             --bs-input-disabled-bg: #1f2937;
             --bs-input-color: #e5e7eb;
             --bs-input-border-color: var(--dark-border);
             --bs-input-placeholder-color: #9ca3af;
        }
        
        body[data-theme="dark"] .navbar {
            background: var(--dark-surface);
            border-bottom-color: var(--dark-border);
        }
        body[data-theme="dark"] .navbar-brand {
            color: var(--primary-color);
        }
        body[data-theme="dark"] .sidebar {
            background-color: var(--dark-surface);
            border-right-color: var(--dark-border);
        }
        body[data-theme="dark"] .sidebar .nav-link { color: #cbd5e1; }
        body[data-theme="dark"] .sidebar .nav-link:hover {
            background-color: rgba(138, 180, 248, 0.1);
            color: var(--primary-color);
        }
        body[data-theme="dark"] .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: var(--dark-color); /* High contrast */
            box-shadow: 0 4px 10px rgba(var(--primary-color-rgb), 0.2);
        }
        
        body[data-theme="dark"] .content-area {
            background-color: var(--dark-color);
        }
        
        body[data-theme="dark"] .stat-card {
            box-shadow: none; 
            border: 1px solid var(--dark-border);
        }

        body[data-theme="dark"] .table-container {
            background: var(--dark-surface);
            box-shadow: none;
            border: 1px solid var(--dark-border);
        }
        body[data-theme="dark"] table thead th {
            background: var(--dark-surface);
            color: #9ca3af;
            border-bottom-color: var(--dark-border);
        }
        body[data-theme="dark"] table tbody tr { border-bottom-color: var(--dark-border); }
        body[data-theme="dark"] table tbody tr:hover { background-color: rgba(138, 180, 248, 0.1); }
        
        body[data-theme="dark"] .modal-content {
            background: var(--dark-surface);
            color: #e5e7eb;
            border: 1px solid var(--dark-border);
            box-shadow: none;
        }
        body[data-theme="dark"] .modal-header .btn-close { filter: invert(1) brightness(2); }
        
        body[data-theme="dark"] .btn-primary {
             box-shadow: 0 2px 6px rgba(var(--primary-color-rgb), 0.2);
        }
        body[data-theme="dark"] .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        body[data-theme="dark"] .btn-outline-primary:hover { 
            background: rgba(var(--primary-color-rgb), 0.1); 
            color: var(--primary-color);
        }
        body[data-theme="dark"] #reports-section .btn.active {
            background-color: var(--primary-color);
            color: var(--dark-color);
            border-color: var(--primary-color);
        }
        body[data-theme="dark"] .btn-secondary {
             --bs-btn-color: #e5e7eb;
             --bs-btn-bg: #374151;
             --bs-btn-border-color: #374151;
             --bs-btn-hover-color: #fff;
             --bs-btn-hover-bg: #4b5563;
             --bs-btn-hover-border-color: #4b5563;
        }

        /* REMOVED: #loadingOverlay dark styles */

        body[data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, #1f2937 25%, #374151 37%, #1f2937 63%);
            background-size: 400% 100%;
        }

        /* Improve floating label appearance in dark mode */
        body[data-theme="dark"] .form-floating > .form-control:-webkit-autofill,
        body[data-theme="dark"] .form-floating > .form-control:-webkit-autofill:hover, 
        body[data-theme="dark"] .form-floating > .form-control:-webkit-autofill:focus, 
        body[data-theme="dark"] .form-floating > .form-control:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px var(--dark-surface) inset !important;
            -webkit-text-fill-color: #e5e7eb !important;
            caret-color: #e5e7eb; /* Add this line */
        }
        body[data-theme="dark"] .form-floating > label {
             color: #9ca3af; /* Adjust label color for better contrast */
        }
        body[data-theme="dark"] .form-floating > .form-control:focus ~ label,
        body[data-theme="dark"] .form-floating > .form-control:not(:placeholder-shown) ~ label,
        body[data-theme="dark"] .form-floating > .form-select ~ label {
             color: var(--primary-color); /* Color when active/floated */
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg"> <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="bi bi-box-seam"></i> 
                <span>Smart Inventory</span>
            </a>
            <div class="d-flex align-items-center gap-2">
                <button id="sidebarToggle" class="btn btn-outline-primary btn-sm d-lg-none" type="button" aria-label="Toggle sidebar">
                    <i class="bi bi-list"></i>
                </button>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="bi bi-bell me-1"></i> Notifications</a>
                    </li>
                    <li class="nav-item mx-2">
                        <button id="themeToggle" class="btn btn-sm d-flex align-items-center" title="Toggle theme"> 
                            <i class="bi bi-moon-fill"></i>
                        </button>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle me-1"></i> <span id="navUserLabel">Guest</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#"><i class="bi bi-person-fill me-2"></i> Profile</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i> Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 sidebar">
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#" data-page="dashboard">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                    <a class="nav-link" href="#" data-page="products">
                        <i class="bi bi-box"></i> Products
                    </a>
                    <a class="nav-link" href="#" data-page="suppliers">
                        <i class="bi bi-truck"></i> Suppliers
                    </a>
                    <a class="nav-link" href="#" data-page="customers">
                        <i class="bi bi-people"></i> Customers
                    </a>
                    <a class="nav-link" href="#" data-page="sales">
                        <i class="bi bi-cart-check"></i> Sales
                    </a>
                    <a class="nav-link" href="#" data-page="purchases">
                        <i class="bi bi-bag-plus"></i> Purchases
                    </a>
                    <a class="nav-link" href="#" data-page="reports">
                        <i class="bi bi-graph-up"></i> Reports
                    </a>
                </nav>
            </div>

            <div class="col-md-10 content-area">
                
                <div id="dashboard-section" class="page-section active"> <div class="page-header">
                        <h2>Dashboard Overview</h2>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card card border-0" style="background-color: var(--bs-primary-bg-subtle);" onclick="navigateToPage('products')">
                                <div class="card-body d-flex align-items-center">
                                    <i class="bi bi-box fs-1 text-primary me-3"></i>
                                    <div>
                                        <h3 id="totalProducts" class="fw-bold text-primary-emphasis">...</h3>
                                        <p class="mb-0 text-primary-emphasis opacity-75">Total Products</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card card border-0" style="background-color: var(--bs-success-bg-subtle);" onclick="navigateToPage('sales')">
                                <div class="card-body d-flex align-items-center">
                                    <i class="bi bi-currency-rupee fs-1 text-success me-3"></i>
                                    <div>
                                        <h3 id="totalSales" class="fw-bold text-success-emphasis">...</h3>
                                        <p class="mb-0 text-success-emphasis opacity-75">Total Sales</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                             <div class="stat-card card border-0" style="background-color: var(--bs-warning-bg-subtle);" onclick="navigateToPage('reports', 'LowStock')"> <div class="card-body d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle fs-1 text-warning me-3"></i>
                                    <div>
                                        <h3 id="lowStockCount" class="fw-bold text-warning-emphasis">...</h3>
                                        <p class="mb-0 text-warning-emphasis opacity-75">Low Stock Items</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                             <div class="stat-card card border-0" style="background-color: var(--bs-info-bg-subtle);" onclick="navigateToPage('customers')">
                                <div class="card-body d-flex align-items-center">
                                    <i class="bi bi-people fs-1 text-info me-3"></i>
                                    <div>
                                        <h3 id="totalCustomers" class="fw-bold text-info-emphasis">...</h3>
                                        <p class="mb-0 text-info-emphasis opacity-75">Total Customers</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="table-container">
                                <h5 class="mb-3"><i class="bi bi-exclamation-circle text-danger me-2"></i>Low Stock Alerts</h5>
                                <div id="lowStockAlerts">
                                     <div class="skeleton mb-2" style="height: 18px;"></div>
                                     <div class="skeleton w-75 mb-2" style="height: 18px;"></div>
                                     <div class="skeleton w-50" style="height: 18px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="products-section" class="page-section">
                    <div class="page-header">
                        <h2>Products Management</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" onclick="openProductModal()">
                            <i class="bi bi-plus-circle me-1"></i> Add Product
                        </button>
                    </div>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <input id="productSearch" type="search" class="form-control" placeholder="Search by name or category..." />
                        </div>
                        <div class="col-md-3">
                            <select id="productPageSize" class="form-select">
                                <option value="5">5 / page</option>
                                <option value="10" selected>10 / page</option>
                                <option value="20">20 / page</option>
                            </select>
                        </div>
                        <div class="col-md-3 text-md-end pt-2"> 
                            <span id="productCount" class="text-muted small"></span>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Supplier</th>
                                    <th>Status</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable">
                                 <tr><td colspan="8"><div class="skeleton my-2"></div></td></tr>
                                 <tr><td colspan="8"><div class="skeleton my-2"></div></td></tr>
                                 <tr><td colspan="8"><div class="skeleton my-2"></div></td></tr>
                                 <tr><td colspan="8"><div class="skeleton my-2"></div></td></tr>
                                 <tr><td colspan="8"><div class="skeleton my-2"></div></td></tr>
                            </tbody>
                        </table>
                        <nav class="d-flex justify-content-end align-items-center">
                            <ul id="productPagination" class="pagination mb-0"></ul>
                        </nav>
                    </div>
                </div>

                <div id="suppliers-section" class="page-section">
                    <div class="page-header">
                        <h2>Suppliers Management</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#supplierModal" onclick="openSupplierModal()">
                            <i class="bi bi-plus-circle me-1"></i> Add Supplier
                        </button>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <input id="supplierSearch" type="search" class="form-control" placeholder="Search by name, contact, phone, or email..." />
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Contact Person</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                             <tbody id="suppliersTable">
                                 <tr><td colspan="6"><div class="skeleton my-2"></div></td></tr>
                                 <tr><td colspan="6"><div class="skeleton my-2"></div></td></tr>
                                 <tr><td colspan="6"><div class="skeleton my-2"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="customers-section" class="page-section">
                    <div class="page-header">
                        <h2>Customers Management</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customerModal" onclick="openCustomerModal()">
                            <i class="bi bi-plus-circle me-1"></i> Add Customer
                        </button>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <input id="customerSearch" type="search" class="form-control" placeholder="Search by name, phone, email, or address..." />
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Address</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customersTable">
                                 <tr><td colspan="6"><div class="skeleton my-2"></div></td></tr>
                                 <tr><td colspan="6"><div class="skeleton my-2"></div></td></tr>
                                 <tr><td colspan="6"><div class="skeleton my-2"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="sales-section" class="page-section">
                    <div class="page-header">
                        <h2>Sales Transactions</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saleModal" onclick="openSaleModal()">
                            <i class="bi bi-plus-circle me-1"></i> Record Sale
                        </button>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <input id="salesSearch" type="search" class="form-control" placeholder="Search by sale id, product, or customer..." />
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Sale ID</th>
                                    <th>Product</th>
                                    <th>Customer</th>
                                    <th>Quantity</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                             <tbody id="salesTable">
                                 <tr><td colspan="6"><div class="skeleton my-2"></div></td></tr>
                                 <tr><td colspan="6"><div class="skeleton my-2"></div></td></tr>
                                 <tr><td colspan="6"><div class="skeleton my-2"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="purchases-section" class="page-section">
                    <div class="page-header">
                        <h2>Purchase Transactions</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#purchaseModal" onclick="openPurchaseModal()">
                            <i class="bi bi-plus-circle me-1"></i> Record Purchase
                        </button>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <input id="purchasesSearch" type="search" class="form-control" placeholder="Search by purchase id, product, or supplier..." />
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Purchase ID</th>
                                    <th>Product</th>
                                    <th>Supplier</th>
                                    <th>Quantity</th>
                                    <th>Unit Cost</th>
                                    <th>Total Cost</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                             <tbody id="purchasesTable">
                                 <tr><td colspan="7"><div class="skeleton my-2"></div></td></tr>
                                 <tr><td colspan="7"><div class="skeleton my-2"></div></td></tr>
                                 <tr><td colspan="7"><div class="skeleton my-2"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="reports-section" class="page-section">
                    <div class="page-header">
                        <h2>Reports & Analytics</h2>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <button class="btn btn-outline-primary w-100 mb-2" onclick="loadReport('TopProducts')">
                                <i class="bi bi-trophy me-1"></i> Top Selling Products
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-primary w-100 mb-2" onclick="loadReport('LowStock')">
                                <i class="bi bi-exclamation-triangle me-1"></i> Low Stock Report
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-primary w-100 mb-2" onclick="loadReport('SalesSummary')">
                                <i class="bi bi-graph-up me-1"></i> Sales Summary
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <h5 id="reportTitle" class="mb-3">Select a report to view</h5>
                        <div id="reportContent">
                             <p class="text-muted">Report data and chart will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 2100;">
        <div id="toastContainer"></div>
    </div>

    

    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Add Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="productName" placeholder="Product Name" required pattern="^[A-Za-z][A-Za-z\s'\-.]{1,}$" inputmode="text" maxlength="100" autocomplete="off" aria-describedby="productNameFeedback">
                            <label for="productName">Product Name *</label>
                            <div id="productNameFeedback" class="invalid-feedback">Enter a valid name: letters, spaces, apostrophes, hyphens, dots; min 2 chars.</div>
                        </div>
                        <div class="form-floating mb-3">
                            <textarea class="form-control" id="productDescription" placeholder="Description" style="height: 100px" maxlength="300" aria-describedby="productDescriptionFeedback"></textarea>
                            <label for="productDescription">Description</label>
                            <div id="productDescriptionFeedback" class="invalid-feedback">Max 300 characters.</div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="productCategory" placeholder="Category" pattern="^[A-Za-z][A-Za-z\s'\-/\.]{1,}$" inputmode="text" maxlength="60" aria-describedby="productCategoryFeedback">
                            <label for="productCategory">Category</label>
                            <div id="productCategoryFeedback" class="invalid-feedback">Use letters, spaces, apostrophes, hyphens, slashes, dots; min 2 chars.</div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" step="0.01" min="0.01" class="form-control" id="productPrice" placeholder="Price" required aria-describedby="productPriceFeedback">
                                    <label for="productPrice">Price *</label>
                                    <div id="productPriceFeedback" class="invalid-feedback">Enter a positive price (min 0.01).</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" min="0" step="1" class="form-control" id="productQuantity" placeholder="Quantity" required aria-describedby="productQuantityFeedback">
                                    <label for="productQuantity">Quantity *</label>
                                    <div id="productQuantityFeedback" class="invalid-feedback">Enter a whole number 0 or greater.</div>
                                </div>
                            </div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="number" min="0" step="1" class="form-control" id="productReorder" value="10" placeholder="Reorder Level" aria-describedby="productReorderFeedback">
                            <label for="productReorder">Reorder Level</label>
                            <div id="productReorderFeedback" class="invalid-feedback">Enter a whole number 0 or greater.</div>
                        </div>
                        <div class="form-floating">
                            <select class="form-select" id="productSupplier" aria-label="Supplier Select"></select>
                            <label for="productSupplier">Supplier</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="supplierModal" tabindex="-1" aria-labelledby="supplierModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="supplierModalTitle">Add Supplier</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="supplierForm">
                        <input type="hidden" id="supplierId">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="supplierName" placeholder="Supplier Name" required pattern="^[A-Za-z][A-Za-z\s'\-.]{1,}$" inputmode="text" maxlength="100" autocomplete="off" aria-describedby="supplierNameFeedback">
                            <label for="supplierName">Supplier Name *</label>
                            <div id="supplierNameFeedback" class="invalid-feedback">Enter a valid name: letters, spaces, apostrophes, hyphens, dots; min 2 chars.</div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="supplierContact" placeholder="Contact Person" pattern="^[A-Za-z][A-Za-z\s'\-.]{1,}$" inputmode="text" maxlength="100" aria-describedby="supplierContactFeedback">
                            <label for="supplierContact">Contact Person</label>
                            <div id="supplierContactFeedback" class="invalid-feedback">Enter a valid name (letters, spaces, apostrophes, hyphens, dots).</div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="tel" class="form-control" id="supplierPhone" placeholder="Phone" inputmode="tel" pattern="^\+?[0-9\s().-]{7,20}$" maxlength="20" aria-describedby="supplierPhoneFeedback">
                            <label for="supplierPhone">Phone</label>
                            <div id="supplierPhoneFeedback" class="invalid-feedback">Enter a valid phone (7-20 chars, digits, +, space, (), ., -).</div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" id="supplierEmail" placeholder="Email" maxlength="120" aria-describedby="supplierEmailFeedback">
                            <label for="supplierEmail">Email</label>
                            <div id="supplierEmailFeedback" class="invalid-feedback">Enter a valid email address.</div>
                        </div>
                        <div class="form-floating">
                            <textarea class="form-control" id="supplierAddress" placeholder="Address" style="height: 100px" maxlength="200" aria-describedby="supplierAddressFeedback"></textarea>
                            <label for="supplierAddress">Address</label>
                            <div id="supplierAddressFeedback" class="invalid-feedback">Max 200 characters.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSupplier()">Save Supplier</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalTitle">Add Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <input type="hidden" id="customerId">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="customerName" placeholder="Customer Name" required pattern="^[A-Za-z][A-Za-z\s'\-.]{1,}$" inputmode="text" maxlength="100" autocomplete="off" aria-describedby="customerNameFeedback">
                            <label for="customerName">Customer Name *</label>
                            <div id="customerNameFeedback" class="invalid-feedback">Enter a valid name: letters, spaces, apostrophes, hyphens, dots; min 2 chars.</div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="tel" class="form-control" id="customerPhone" placeholder="Phone" inputmode="tel" pattern="^\+?[0-9\s().-]{7,20}$" maxlength="20" aria-describedby="customerPhoneFeedback">
                            <label for="customerPhone">Phone</label>
                            <div id="customerPhoneFeedback" class="invalid-feedback">Enter a valid phone (7-20 chars, digits, +, space, (), ., -).</div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" id="customerEmail" placeholder="Email" maxlength="120" aria-describedby="customerEmailFeedback">
                            <label for="customerEmail">Email</label>
                            <div id="customerEmailFeedback" class="invalid-feedback">Enter a valid email address.</div>
                        </div>
                        <div class="form-floating">
                            <textarea class="form-control" id="customerAddress" placeholder="Address" style="height: 100px" maxlength="200" aria-describedby="customerAddressFeedback"></textarea>
                            <label for="customerAddress">Address</label>
                            <div id="customerAddressFeedback" class="invalid-feedback">Max 200 characters.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCustomer()">Save Customer</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="saleModal" tabindex="-1" aria-labelledby="saleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Record Sale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="saleForm">
                        <div class="form-floating mb-3">
                            <select class="form-select" id="saleProduct" required aria-label="Product Select" aria-describedby="saleProductFeedback"></select>
                            <label for="saleProduct">Product *</label>
                            <div id="saleProductFeedback" class="invalid-feedback">Please select a product.</div>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="saleCustomer" required aria-label="Customer Select" aria-describedby="saleCustomerFeedback"></select>
                            <label for="saleCustomer">Customer *</label>
                            <div id="saleCustomerFeedback" class="invalid-feedback">Please select a customer.</div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="number" class="form-control" id="saleQuantity" placeholder="Quantity" required min="1" step="1" aria-describedby="saleQuantityFeedback">
                            <label for="saleQuantity">Quantity *</label>
                            <div id="saleQuantityFeedback" class="invalid-feedback">Enter a whole number of at least 1.</div>
                        </div>
                        <div class="alert alert-info d-flex align-items-center" role="alert">
                           <i class="bi bi-info-circle flex-shrink-0 me-2"></i>
                            <div>Total amount will be calculated automatically.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSale()">Record Sale</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="purchaseModal" tabindex="-1" aria-labelledby="purchaseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Record Purchase</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="purchaseForm">
                        <div class="form-floating mb-3">
                            <select class="form-select" id="purchaseProduct" required aria-label="Product Select" aria-describedby="purchaseProductFeedback"></select>
                            <label for="purchaseProduct">Product *</label>
                            <div id="purchaseProductFeedback" class="invalid-feedback">Please select a product.</div>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="purchaseSupplier" required aria-label="Supplier Select" aria-describedby="purchaseSupplierFeedback"></select>
                            <label for="purchaseSupplier">Supplier *</label>
                            <div id="purchaseSupplierFeedback" class="invalid-feedback">Please select a supplier.</div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="purchaseQuantity" placeholder="Quantity" required min="1" step="1" aria-describedby="purchaseQuantityFeedback">
                                    <label for="purchaseQuantity">Quantity *</label>
                                    <div id="purchaseQuantityFeedback" class="invalid-feedback">Enter a whole number of at least 1.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" step="0.01" min="0.01" class="form-control" id="purchaseCost" placeholder="Unit Cost" required aria-describedby="purchaseCostFeedback">
                                    <label for="purchaseCost">Unit Cost *</label>
                                    <div id="purchaseCostFeedback" class="invalid-feedback">Enter a positive cost (min 0.01).</div>
                                </div>
                            </div>
                        </div>
                         <div class="alert alert-info d-flex align-items-center" role="alert">
                           <i class="bi bi-info-circle flex-shrink-0 me-2"></i>
                            <div>Total cost will be calculated automatically.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePurchase()">Record Purchase</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_BASE_URL = '';
        const API_URL = API_BASE_URL + '/api';

        // --- UX Helpers ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) {
                 console.error("Toast container not found!");
                 return;
             }

            const color = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : type === 'warning' ? 'bg-warning text-dark' : 'bg-primary';
            const el = document.createElement('div');
            // Ensure toast class is present for proper styling and JS initialization
            el.className = `toast align-items-center text-white ${color} border-0`;
            el.setAttribute('role', 'alert');
            el.setAttribute('aria-live', 'assertive');
            el.setAttribute('aria-atomic', 'true');
            el.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;

            container.appendChild(el);

             try {
                 const toast = new bootstrap.Toast(el, { delay: 3500 }); // Slightly longer delay
                 toast.show();
                 el.addEventListener('hidden.bs.toast', () => el.remove(), { once: true }); // Use { once: true } for cleanup
             } catch (e) {
                  console.error("Error showing toast:", e);
                  el.remove(); // Clean up if bootstrap failed
             }
        }

        function getAuthToken(){ try { return localStorage.getItem('authToken') || ''; } catch { return ''; } }
        function setAuth(token){ try { localStorage.setItem('authToken', token||''); } catch {} }
        function clearAuth(){ try { localStorage.removeItem('authToken'); } catch {} }

        async function apiFetch(url, options = {}, { useOverlay = false } = {}) {
            // No global overlay used anymore
            try {
                const token = getAuthToken();
                const authHeader = token ? { 'Authorization': `Bearer ${token}` } : {};
                const defaultHeaders = { 'Content-Type': 'application/json', 'Accept': 'application/json', ...authHeader, ...options.headers };
                const fetchOptions = { ...options, headers: defaultHeaders };
                 // Ensure body is stringified only if it's a JS object and method is not GET/HEAD
                 if (fetchOptions.body && typeof fetchOptions.body !== 'string' && !(['GET', 'HEAD'].includes(fetchOptions.method?.toUpperCase()))) {
                      fetchOptions.body = JSON.stringify(fetchOptions.body);
                 } else if (['GET', 'HEAD'].includes(fetchOptions.method?.toUpperCase())) {
                      delete fetchOptions.body; // Body not allowed for GET/HEAD
                 }

                const res = await fetch(url, fetchOptions);
                const isJson = (res.headers.get('content-type') || '').includes('application/json');
                
                // Attempt to parse JSON even on error for backend messages
                let body;
                 try {
                      body = isJson ? await res.json() : await res.text();
                 } catch (parseError) {
                      console.error("Error parsing response body:", parseError);
                      // If parsing fails after non-ok status, use status text
                      if (!res.ok) throw new Error(res.statusText || `Request failed with status ${res.status}`);
                      body = "Response parsing error"; // Fallback for ok response with bad body
                 }


                if (!res.ok) {
                    if (res.status === 401) {
                        clearAuth();
                        try { window.location.href = '/'; } catch {}
                    }
                    let errorMsg = `Request failed (${res.status} ${res.statusText})`;
                    // Prioritize backend JSON error message
                    if (isJson && body && body.error) {
                        errorMsg = body.error;
                    } else if (!isJson && typeof body === 'string' && body.trim()) {
                        // Use text response if available and not empty
                        errorMsg = body.trim();
                    }
                     console.error("API Error Response Body:", body);
                    throw new Error(errorMsg);
                }
                return body;
            } catch (error) {
                 console.error(`API Fetch Error (${url}):`, error);
                 // Re-throw a more specific error if possible, otherwise the original
                 throw new Error(error.message || `Network error or invalid response from ${url}`);
            }
        }

        // --- Chart Helper ---
        let reportChart = null; // Initialize as null
        function renderChart(ctx, type, data, options){
            // Ensure Chart.js is loaded
            if (typeof Chart === 'undefined') {
                 // Try loading it again if needed, or just warn
                console.warn("Chart.js not loaded. Cannot render chart.");
                // Optionally append script if missing
                if (!document.querySelector('script[src*="chart.umd.min.js"]')) {
                     const chartScript = document.createElement('script');
                     chartScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js';
                     chartScript.onload = () => console.log("Chart.js loaded dynamically.");
                     chartScript.onerror = () => console.error("Failed to load Chart.js dynamically");
                     document.body.appendChild(chartScript);
                }
                return;
            }

            if (reportChart) {
                 try {
                      reportChart.destroy();
                 } catch (e) { console.error("Error destroying previous chart:", e); }
                 reportChart = null; // Reset reference
            }

            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDark ? '#e5e7eb' : '#495057';

            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: textColor } },
                    tooltip: {
                         bodyColor: textColor, titleColor: textColor,
                         backgroundColor: isDark ? 'rgba(31, 41, 55, 0.9)' : 'rgba(255, 255, 255, 0.9)',
                         borderColor: gridColor, borderWidth: 1
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                    x: { grid: { color: gridColor }, ticks: { color: textColor } }
                }
            };
            
             try {
                 reportChart = new Chart(ctx, { type, data, options: { ...defaultOptions, ...options } });
             } catch (e) {
                  console.error("Error creating chart:", e);
                  showToast("Could not display chart.", "error");
             }
        }

        // --- Formatters ---
        const INR = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 });
        function formatCurrency(value) {
            const num = Number(value || 0);
            return Number.isFinite(num) ? INR.format(num) : '0';
        }

        // --- Theme Toggle ---
        (function initTheme(){
            const btn = document.getElementById('themeToggle');
            const nav = document.querySelector('.navbar');
            if (!btn || !nav) return;
            const icon = btn.querySelector('i');

            const setTheme = (theme) => {
                const isDark = theme === 'dark';
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);

                icon.classList.toggle('bi-moon-fill', !isDark);
                icon.classList.toggle('bi-sun-fill', isDark);
                btn.classList.toggle('btn-outline-secondary', !isDark);
                btn.classList.toggle('btn-outline-light', isDark);
                nav.classList.toggle('navbar-dark', isDark);

                // Re-render chart only if reports section is active
                if (reportChart && document.getElementById('reports-section')?.classList.contains('active')) {
                    const activeReportBtn = document.querySelector('#reports-section .btn.active');
                    if (activeReportBtn) {
                        const onclickAttr = activeReportBtn.getAttribute('onclick');
                        const match = onclickAttr?.match(/loadReport\('([^']+)'\)/);
                        if (match && match[1]) {
                             // Introduce a tiny delay to allow CSS vars to update fully
                            setTimeout(() => loadReport(match[1]), 50);
                        }
                    }
                }
            };

            const saved = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            setTheme(saved); // Apply theme immediately on load

            btn.addEventListener('click', ()=>{
                const currentTheme = document.body.getAttribute('data-theme');
                setTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });
        })();
        
        // --- Navigation ---
        function navigateToPage(pageName, reportType = null) {
            console.log(`Navigating to: ${pageName}${reportType ? ` (${reportType})` : ''}`); // Debug log
            const targetLink = document.querySelector(`.sidebar .nav-link[data-page='${pageName}']`);
            if (targetLink) {
                 // Check if it's already active to prevent unnecessary re-clicks/reloads
                 if (!targetLink.classList.contains('active')) {
                     targetLink.click();
                 } else if (pageName === 'reports' && reportType) {
                      // If already on reports, just load the specific report
                       const reportButton = document.querySelector(`#reports-section .btn[onclick="loadReport('${reportType}')"]`);
                       if(reportButton && !reportButton.classList.contains('active')) reportButton.click();
                 }

                 // Special handling for reports link from dashboard card
                 if (pageName === 'reports' && reportType && targetLink.classList.contains('active')) {
                     setTimeout(() => {
                          const reportButton = document.querySelector(`#reports-section .btn[onclick="loadReport('${reportType}')"]`);
                           if(reportButton) reportButton.click();
                     }, 50);
                 }
            } else {
                 console.error(`Navigation target link not found for page: ${pageName}`);
                 showToast(`Error: Could not find navigation link for ${pageName}.`, "error");
            }
        }

        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                // Prevent re-loading if clicking the already active link
                if (this.classList.contains('active')) {
                     console.log(`Link ${this.dataset.page} already active.`);
                     return;
                 }

                console.log(`Sidebar link clicked: ${this.dataset.page}`); // Debug log

                document.querySelector('.sidebar .nav-link.active')?.classList.remove('active');
                this.classList.add('active');

                const page = this.dataset.page;

                document.querySelectorAll('.page-section').forEach(section => {
                     section.classList.remove('active');
                });
                const targetSection = document.getElementById(`${page}-section`);
                if (targetSection) {
                     targetSection.classList.add('active');
                     console.log(`Loading data for page: ${page}`); // Debug log
                     loadPageData(page); // Load data AFTER section is made active
                 } else {
                      console.error(`Page section not found for id: ${page}-section`);
                       showToast(`Error: UI section for ${page} not found.`, "error");
                 }
            });
        });

        function loadPageData(page) {
             console.log(`Executing loadPageData for: ${page}`); // Debug log
            // Clear previous report chart if navigating away from reports
             if (page !== 'reports' && reportChart) {
                 reportChart.destroy();
                 reportChart = null;
             }

            // Centralized error handling wrapper for load functions
             const loadFunction = async (func) => {
                  try {
                       await func();
                  } catch(error) {
                       console.error(`Error loading data for ${page}:`, error);
                       // Display error within the specific section if possible
                        const sectionContent = document.querySelector(`#${page}-section .table-container tbody, #${page}-section #reportContent, #${page}-section #lowStockAlerts`); // Common containers
                        if (sectionContent) {
                             // Adapt error message based on container type
                             if (sectionContent.tagName === 'TBODY') {
                                 const colspan = sectionContent.closest('table')?.querySelector('thead tr th')?.length || 1;
                                 sectionContent.innerHTML = `<tr><td colspan="${colspan}" class="text-danger text-center py-4">Failed to load data: ${error.message || 'Unknown error'}</td></tr>`;
                             } else {
                                  sectionContent.innerHTML = `<p class="text-danger text-center py-4">Failed to load data: ${error.message || 'Unknown error'}</p>`;
                             }
                        } else {
                             // Fallback toast if no specific container found
                             showToast(`Failed to load ${page} data: ${error.message}`, "error");
                        }
                  }
             };


            switch(page) {
                case 'dashboard': loadFunction(loadDashboard); break;
                case 'products': loadFunction(loadProducts); break;
                case 'suppliers': loadFunction(loadSuppliers); break;
                case 'customers': loadFunction(loadCustomers); break;
                case 'sales': loadFunction(loadSales); break;
                case 'purchases': loadFunction(loadPurchases); break;
                case 'reports':
                    // Reset reports section, don't trigger loadFunction here, report buttons do it
                    document.getElementById('reportTitle').textContent = 'Select a report to view';
                    document.getElementById('reportContent').innerHTML = '<p class="text-muted">Report data and chart will appear here.</p>';
                    document.querySelectorAll('#reports-section .btn-outline-primary').forEach(b => b.classList.remove('active'));
                    if (reportChart) { reportChart.destroy(); reportChart = null; }
                    break;
                default: console.warn(`No data loading logic defined for page: ${page}`);
            }
        }

        // --- Data Loading & Rendering Functions (with improved error handling) ---

        // Dashboard
        async function loadDashboard() {
            const totalProductsEl = document.getElementById('totalProducts');
            const totalSalesEl = document.getElementById('totalSales');
            const lowStockCountEl = document.getElementById('lowStockCount');
            const totalCustomersEl = document.getElementById('totalCustomers');

            totalProductsEl.innerHTML = '<span class="skeleton w-50"></span>';
            totalSalesEl.innerHTML = '<span class="skeleton w-75"></span>';
            lowStockCountEl.innerHTML = '<span class="skeleton w-25"></span>';
            totalCustomersEl.innerHTML = '<span class="skeleton w-50"></span>';

            // Fetch main stats first - Let error propagate up if this fails
            const data = await apiFetch(`${API_URL}/dashboard`);

            totalProductsEl.textContent = data.TotalProducts;
            totalSalesEl.textContent = `${data.TotalSales.toLocaleString()}`;
            lowStockCountEl.textContent = data.LowStockCount;
            totalCustomersEl.textContent = data.TotalCustomers;
            
            // Load alerts separately, handle its potential failure independently
             try {
                 // Use await here to ensure it tries to load before function returns
                 await loadLowStockAlerts(); 
             } catch (alertError) {
                  console.error("Non-critical error loading low stock alerts:", alertError);
                   const alertsDiv = document.getElementById('lowStockAlerts');
                   if (alertsDiv) alertsDiv.innerHTML = '<p class="text-warning mb-0">Could not load low stock alerts.</p>';
             }
        }

        async function loadLowStockAlerts() {
            const alertsDiv = document.getElementById('lowStockAlerts');
            if (!alertsDiv) return; // Add guard clause
            alertsDiv.innerHTML = `<div class="skeleton mb-2" style="height: 18px;"></div><div class="skeleton w-75 mb-2" style="height: 18px;"></div>`;
            
            // Fetch low stock data - propagate error if it fails
            const products = await apiFetch(`${API_URL}/reports/low-stock`); 

            if (products.length === 0) {
                alertsDiv.innerHTML = '<p class="text-muted mb-0">No low stock items found.</p>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm table-hover align-middle mb-0"><thead><tr><th>Product</th><th>Category</th><th>Stock</th><th>Reorder</th><th>Supplier</th></tr></thead><tbody>';
            products.slice(0, 5).forEach(p => {
                html += `<tr class="table-warning">
                    <td>${p.ProductName}</td>
                    <td>${p.Category || 'N/A'}</td>
                    <td><span class="badge bg-danger">${p.Quantity}</span></td>
                    <td>${p.ReorderLevel}</td>
                    <td>${p.SupplierName || 'N/A'}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            if(products.length > 5) {
                html += `<div class="text-center mt-2"><button class="btn btn-sm btn-outline-warning" onclick="navigateToPage('reports', 'LowStock')">View All (${products.length})</button></div>`;
            }
            alertsDiv.innerHTML = html;
        }


        // Products
        let productsData = [];
        let productsFiltered = [];
        let productsPage = 1;
        const productsTableBody = document.getElementById('productsTable');

        function renderProductSkeleton() {
            if (!productsTableBody) return;
            let skeletonHTML = '';
            const rowsToShow = parseInt(document.getElementById('productPageSize')?.value) || 5;
            for(let i = 0; i < rowsToShow; i++) {
                 skeletonHTML += `<tr><td colspan="8"><div class="skeleton my-2" style="height: 20px;"></div></td></tr>`;
            }
            productsTableBody.innerHTML = skeletonHTML;
            document.getElementById('productPagination').innerHTML = '';
            document.getElementById('productCount').textContent = 'Loading...';
        }

        async function loadProducts() {
            renderProductSkeleton();
            productsData = await apiFetch(`${API_URL}/products`); // Propagates error
            // Sort by ProductID ascending
            productsData = Array.isArray(productsData) ? productsData.slice().sort((a,b) => (a?.ProductID||0) - (b?.ProductID||0)) : [];
            productsFiltered = productsData;
            productsPage = 1;
            wireProductControls();
            renderProducts();
        }

        let productControlsWired = false;
        function wireProductControls(){
            if (productControlsWired) return;
            const search = document.getElementById('productSearch');
            const pageSizeSel = document.getElementById('productPageSize');
            if (search) search.addEventListener('input', filterProducts);
            if (pageSizeSel) pageSizeSel.addEventListener('change', () => { productsPage = 1; renderProducts(); });
            productControlsWired = true;
        }

        function filterProducts(){
            const q = document.getElementById('productSearch')?.value?.toLowerCase() || '';
            productsFiltered = productsData.filter(p =>
                (p.ProductName || '').toLowerCase().includes(q) ||
                (p.Category || '').toLowerCase().includes(q)
            );
            productsPage = 1;
            renderProducts();
        }

        function renderProducts(){
            if (!productsTableBody) return;

            const pageSize = parseInt(document.getElementById('productPageSize')?.value) || 10;
            const total = productsFiltered.length;
            const countEl = document.getElementById('productCount');
            const paginationEl = document.getElementById('productPagination');

            if (total === 0) {
                productsTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No products found matching your criteria.</td></tr>';
                if (paginationEl) paginationEl.innerHTML = '';
                if (countEl) countEl.textContent = '0 items';
                return;
            }
            
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (productsPage > totalPages) productsPage = totalPages;
            if (productsPage < 1) productsPage = 1;

            const start = (productsPage - 1) * pageSize;
            const end = start + pageSize;
            const rows = productsFiltered.slice(start, end);
            
            if (countEl) countEl.textContent = `Showing ${start + 1}-${start + rows.length} of ${total} items`;

            let tableHTML = '';
            rows.forEach(p => {
                const isLow = p.Quantity <= p.ReorderLevel;
                const isOut = p.Quantity <= 0;
                const statusBadge = isOut ? `<span class="badge bg-danger-subtle text-danger-emphasis">Out of Stock</span>` : isLow ? `<span class="badge bg-warning-subtle text-warning-emphasis">Low Stock</span>` : '<span class="badge bg-success-subtle text-success-emphasis">In Stock</span>';
                
                tableHTML += `<tr>
                    <td>${p.ProductID}</td>
                    <td>${p.ProductName || 'N/A'}</td>
                    <td>${p.Category || 'N/A'}</td>
                    <td>${parseFloat(p.Price || 0).toLocaleString()}</td>
                    <td>${p.Quantity}</td>
                    <td>${p.SupplierName || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${p.ProductID})" title="Edit Product"><i class="bi bi-pencil-fill"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${p.ProductID})" title="Delete Product"><i class="bi bi-trash-fill"></i></button>
                    </td>
                </tr>`;
            });
             productsTableBody.innerHTML = tableHTML;

            renderPagination(paginationEl, productsPage, totalPages, (page) => {
                 productsPage = page;
                 renderProducts();
            });
        }
        
        function renderPagination(container, currentPage, totalPages, onPageClick) {
            if (!container || totalPages <= 1) {
                if (container) container.innerHTML = ''; return;
            }
            container.innerHTML = '';
            const createPageItem = (label, page, isDisabled = false, isActive = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
                const a = document.createElement('a'); a.className = 'page-link'; a.href = '#'; a.innerHTML = label;
                if (!isDisabled) a.onclick = (e) => { e.preventDefault(); onPageClick(page); };
                li.appendChild(a); return li;
            };
            container.appendChild(createPageItem('&laquo;', 1, currentPage === 1));
            container.appendChild(createPageItem('&lsaquo;', currentPage - 1, currentPage === 1));
            const windowSize = 2; let startPage = Math.max(1, currentPage - windowSize); let endPage = Math.min(totalPages, currentPage + windowSize);
            if (startPage > 1) { container.appendChild(createPageItem('1', 1)); if (startPage > 2) container.appendChild(createPageItem('...', currentPage - windowSize -1, true)); }
            for (let p = startPage; p <= endPage; p++) container.appendChild(createPageItem(String(p), p, false, p === currentPage));
             if (endPage < totalPages) { if (endPage < totalPages - 1) container.appendChild(createPageItem('...', currentPage + windowSize + 1, true)); container.appendChild(createPageItem(String(totalPages), totalPages)); }
            container.appendChild(createPageItem('&rsaquo;', currentPage + 1, currentPage === totalPages));
            container.appendChild(createPageItem('&raquo;', totalPages, currentPage === totalPages));
        }

        // Product Modal Logic
        function openProductModal(product = null) {
            const modalEl = document.getElementById('productModal');
            const modalTitle = document.getElementById('productModalTitle');
            const form = document.getElementById('productForm');
            if (!modalEl || !modalTitle || !form) return;
            form.reset(); document.getElementById('productId').value = '';
            if (product) {
                modalTitle.textContent = 'Edit Product';
                document.getElementById('productId').value = product.ProductID;
                document.getElementById('productName').value = product.ProductName;
                document.getElementById('productDescription').value = product.Description || '';
                document.getElementById('productCategory').value = product.Category || '';
                document.getElementById('productPrice').value = product.Price;
                document.getElementById('productQuantity').value = product.Quantity;
                document.getElementById('productReorder').value = product.ReorderLevel;
                loadSupplierDropdown('productSupplier').then(() => { document.getElementById('productSupplier').value = product.SupplierID || ''; });
            } else {
                modalTitle.textContent = 'Add Product';
                loadSupplierDropdown('productSupplier');
            }
             const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl); modalInstance.show();
        }
        async function editProduct(id) {
            try {
                showToast("Loading product details...", "info");
                const product = await apiFetch(`${API_URL}/products/${id}`);
                openProductModal(product);
            } catch (error) { showToast(`Failed to load product details: ${error.message}`, 'error'); }
        }
        async function saveProduct() {
             const form = document.getElementById('productForm');
             if (!form.checkValidity()) { form.reportValidity(); showToast('Please fill all required fields correctly.', 'warning'); return; }
            const id = document.getElementById('productId').value;
            const data = {
                ProductName: document.getElementById('productName').value.trim(), Description: document.getElementById('productDescription').value.trim(), Category: document.getElementById('productCategory').value.trim(),
                Price: parseFloat(document.getElementById('productPrice').value), Quantity: parseInt(document.getElementById('productQuantity').value), ReorderLevel: parseInt(document.getElementById('productReorder').value), SupplierID: document.getElementById('productSupplier').value || null
            };
             if (!data.ProductName || data.Price < 0 || data.Quantity < 0 || data.ReorderLevel < 0) { showToast('Invalid data...', 'warning'); return; }
            const url = id ? `${API_URL}/products/${id}` : `${API_URL}/products`; const method = id ? 'PUT' : 'POST';
            const saveButton = document.querySelector('#productModal .btn-primary'); const originalButtonText = saveButton.innerHTML; saveButton.disabled = true; saveButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving...`;
            try {
                await apiFetch(url, { method, body: data }); // Pass object directly
                bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                showToast(`Product ${id ? 'updated' : 'added'}!`, 'success');
                await loadProducts(); // Use await
                if (document.getElementById('dashboard-section').classList.contains('active')) await loadDashboard(); // Use await
            } catch (error) { showToast(`Error saving product: ${error.message}`, 'error'); }
            finally { saveButton.disabled = false; saveButton.innerHTML = originalButtonText; }
        }
        async function deleteProduct(id) {
            if (!confirm(`Delete product ID ${id}?`)) return;
            try {
                 showToast("Deleting product...", "info");
                await apiFetch(`${API_URL}/products/${id}`, { method: 'DELETE' });
                showToast('Product deleted!', 'success');
                await loadProducts(); // Use await
                 if (document.getElementById('dashboard-section').classList.contains('active')) await loadDashboard(); // Use await
            } catch (error) { showToast(`Error deleting product: ${error.message}`, 'error'); }
        }

        // --- Suppliers (CRUD + Search) ---
        let suppliersData = [];
        let suppliersFiltered = [];
        const suppliersTableBody = document.getElementById('suppliersTable');
        let supplierControlsWired = false;
        function wireSupplierControls(){
            if (supplierControlsWired) return;
            const search = document.getElementById('supplierSearch');
            if (search) search.addEventListener('input', filterSuppliers);
            supplierControlsWired = true;
        }
        function renderSupplierSkeleton() { /* ... */
             if (!suppliersTableBody) return;
              let s = ''; for(let i=0; i<3; i++) s += `<tr><td colspan="6"><div class="skeleton my-2" style="height:20px"></div></td></tr>`;
              suppliersTableBody.innerHTML = s;
        }
        async function loadSuppliers() {
            renderSupplierSkeleton();
            suppliersData = await apiFetch(`${API_URL}/suppliers`); // Propagates error
            suppliersData = Array.isArray(suppliersData) ? suppliersData.slice().sort((a,b) => (a?.SupplierID||0) - (b?.SupplierID||0)) : [];
            suppliersFiltered = suppliersData;
            wireSupplierControls();
            renderSuppliers();
        }
        function filterSuppliers(){
            const q = document.getElementById('supplierSearch')?.value?.toLowerCase() || '';
            suppliersFiltered = suppliersData.filter(s =>
                String(s.SupplierID||'').includes(q) ||
                (s.SupplierName||'').toLowerCase().includes(q) ||
                (s.ContactPerson||'').toLowerCase().includes(q) ||
                (s.Phone||'').toLowerCase().includes(q) ||
                (s.Email||'').toLowerCase().includes(q)
            );
            renderSuppliers();
        }
        function renderSuppliers(){
            if (!suppliersTableBody) return;
            if (suppliersFiltered.length === 0) { suppliersTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No suppliers found.</td></tr>'; return; }
            let t = '';
            suppliersFiltered.forEach(s => t += `<tr><td>${s.SupplierID}</td><td>${s.SupplierName||'N/A'}</td><td>${s.ContactPerson||'N/A'}</td><td>${s.Phone||'N/A'}</td><td>${s.Email||'N/A'}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary" onclick="editSupplier(${s.SupplierID})" title="Edit"><i class="bi bi-pencil-fill"></i></button> <button class="btn btn-sm btn-outline-danger" onclick="deleteSupplier(${s.SupplierID})" title="Delete"><i class="bi bi-trash-fill"></i></button></td></tr>`);
            suppliersTableBody.innerHTML = t;
        }
        function openSupplierModal(supplier = null) { /* ... */
             const m=document.getElementById('supplierModal'), t=document.getElementById('supplierModalTitle'), f=document.getElementById('supplierForm'); if(!m||!t||!f)return; f.reset(); document.getElementById('supplierId').value=''; if(supplier){t.textContent='Edit';document.getElementById('supplierId').value=supplier.SupplierID;document.getElementById('supplierName').value=supplier.SupplierName;document.getElementById('supplierContact').value=supplier.ContactPerson||'';document.getElementById('supplierPhone').value=supplier.Phone||'';document.getElementById('supplierEmail').value=supplier.Email||'';document.getElementById('supplierAddress').value=supplier.Address||'';}else{t.textContent='Add';} bootstrap.Modal.getOrCreateInstance(m).show();
         }
        async function editSupplier(id) { /* ... */ try { showToast("Loading...", "info"); const s=await apiFetch(`${API_URL}/suppliers/${id}`); openSupplierModal(s); } catch(e){showToast(`Load failed: ${e.message}`,'error');} }
        async function saveSupplier() { /* ... */
             const f=document.getElementById('supplierForm'); if(!f.checkValidity()){f.reportValidity();showToast('Name required.','warning');return;} const id=document.getElementById('supplierId').value; const d={SupplierName:document.getElementById('supplierName').value.trim(),ContactPerson:document.getElementById('supplierContact').value.trim(),Phone:document.getElementById('supplierPhone').value.trim(),Email:document.getElementById('supplierEmail').value.trim(),Address:document.getElementById('supplierAddress').value.trim()}; const u=id?`${API_URL}/suppliers/${id}`:`${API_URL}/suppliers`; const m=id?'PUT':'POST'; const b=document.querySelector('#supplierModal .btn-primary'); const o=b.innerHTML; b.disabled=true; b.innerHTML=`<span class="spinner-border spinner-border-sm"></span> Saving...`; try {await apiFetch(u,{method:m,body:d}); bootstrap.Modal.getInstance(document.getElementById('supplierModal')).hide(); showToast(`Supplier ${id?'updated':'added'}!`,'success'); await loadSuppliers();} catch(e){showToast(`Save failed: ${e.message}`,'error');} finally {b.disabled=false; b.innerHTML=o;}
         }
        async function deleteSupplier(id) { /* ... */ if(!confirm(`Delete supplier ${id}?`))return; try {showToast("Deleting...", "info"); await apiFetch(`${API_URL}/suppliers/${id}`,{method:'DELETE'}); showToast('Deleted!','success'); await loadSuppliers(); if(document.getElementById('products-section').classList.contains('active')) await loadProducts();} catch(e){showToast(`Delete failed: ${e.message}`,'error');}}

        // --- Customers (CRUD + Search) ---
        let customersData = [];
        let customersFiltered = [];
        const customersTableBody = document.getElementById('customersTable');
        let customerControlsWired = false;
        function wireCustomerControls(){ if(customerControlsWired) return; const s=document.getElementById('customerSearch'); if(s) s.addEventListener('input', filterCustomers); customerControlsWired = true; }
        function renderCustomerSkeleton() { /* ... */ if(!customersTableBody)return; let s=''; for(let i=0;i<3;i++)s+=`<tr><td colspan="6"><div class="skeleton my-2" style="height:20px"></div></td></tr>`; customersTableBody.innerHTML=s;}
        async function loadCustomers() { /* ... */
             renderCustomerSkeleton();
             customersData = await apiFetch(`${API_URL}/customers`); // Propagates error
             customersData = Array.isArray(customersData) ? customersData.slice().sort((a,b) => (a?.CustomerID||0) - (b?.CustomerID||0)) : [];
             customersFiltered = customersData;
             wireCustomerControls();
             renderCustomers();
         }
        function filterCustomers(){
            const q = document.getElementById('customerSearch')?.value?.toLowerCase() || '';
            customersFiltered = customersData.filter(c =>
                String(c.CustomerID||'').includes(q) ||
                (c.CustomerName||'').toLowerCase().includes(q) ||
                (c.Phone||'').toLowerCase().includes(q) ||
                (c.Email||'').toLowerCase().includes(q) ||
                (c.Address||'').toLowerCase().includes(q)
            );
            renderCustomers();
        }
        function renderCustomers(){
            if(!customersTableBody) return;
            if(customersFiltered.length===0){customersTableBody.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4">No customers found.</td></tr>'; return;}
            let t=''; customersFiltered.forEach(c=>t+=`<tr><td>${c.CustomerID}</td><td>${c.CustomerName||'N/A'}</td><td>${c.Phone||'N/A'}</td><td>${c.Email||'N/A'}</td><td>${c.Address||'N/A'}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary" onclick="editCustomer(${c.CustomerID})" title="Edit"><i class="bi bi-pencil-fill"></i></button> <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer(${c.CustomerID})" title="Delete"><i class="bi bi-trash-fill"></i></button></td></tr>`);
            customersTableBody.innerHTML=t;
        }
        function openCustomerModal(customer = null) { /* ... */ const m=document.getElementById('customerModal'), t=document.getElementById('customerModalTitle'), f=document.getElementById('customerForm'); if(!m||!t||!f)return; f.reset(); document.getElementById('customerId').value=''; if(customer){t.textContent='Edit';document.getElementById('customerId').value=customer.CustomerID;document.getElementById('customerName').value=customer.CustomerName;document.getElementById('customerPhone').value=customer.Phone||'';document.getElementById('customerEmail').value=customer.Email||'';document.getElementById('customerAddress').value=customer.Address||'';}else{t.textContent='Add';} bootstrap.Modal.getOrCreateInstance(m).show();}
        async function editCustomer(id) { /* ... */ try {showToast("Loading...", "info"); const c=await apiFetch(`${API_URL}/customers/${id}`); openCustomerModal(c);} catch(e){showToast(`Load failed: ${e.message}`,'error');}}
        async function saveCustomer() { /* ... */
             const f=document.getElementById('customerForm'); if(!f.checkValidity()){f.reportValidity();showToast('Name required.','warning');return;} const id=document.getElementById('customerId').value; const d={CustomerName:document.getElementById('customerName').value.trim(),Phone:document.getElementById('customerPhone').value.trim(),Email:document.getElementById('customerEmail').value.trim(),Address:document.getElementById('customerAddress').value.trim()}; const u=id?`${API_URL}/customers/${id}`:`${API_URL}/customers`; const m=id?'PUT':'POST'; const b=document.querySelector('#customerModal .btn-primary'); const o=b.innerHTML; b.disabled=true; b.innerHTML=`<span class="spinner-border spinner-border-sm"></span> Saving...`; try {await apiFetch(u,{method:m,body:d}); bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide(); showToast(`Customer ${id?'updated':'added'}!`,'success'); await loadCustomers(); if(document.getElementById('dashboard-section').classList.contains('active')) await loadDashboard();} catch(e){showToast(`Save failed: ${e.message}`,'error');} finally {b.disabled=false; b.innerHTML=o;}
         }
        async function deleteCustomer(id) { /* ... */ if(!confirm(`Delete customer ${id}?`))return; try {showToast("Deleting...", "info"); await apiFetch(`${API_URL}/customers/${id}`,{method:'DELETE'}); showToast('Deleted!','success'); await loadCustomers(); if(document.getElementById('dashboard-section').classList.contains('active')) await loadDashboard();} catch(e){showToast(`Delete failed: ${e.message}`,'error');}}

        // --- Sales (Read, Create + Search) ---
        let salesData = [];
        let salesFiltered = [];
        const salesTableBody = document.getElementById('salesTable');
        let salesControlsWired = false;
        function wireSalesControls(){ if(salesControlsWired) return; const s=document.getElementById('salesSearch'); if(s) s.addEventListener('input', filterSales); salesControlsWired = true; }
        function renderSalesSkeleton() { /* ... */ if(!salesTableBody)return; let s=''; for(let i=0;i<3;i++)s+=`<tr><td colspan="6"><div class="skeleton my-2" style="height:20px"></div></td></tr>`; salesTableBody.innerHTML=s;}
        async function loadSales() { /* ... */
             renderSalesSkeleton();
             salesData = await apiFetch(`${API_URL}/sales`); // Propagates error
             salesData = Array.isArray(salesData) ? salesData.slice().sort((a,b) => (a?.SaleID||0) - (b?.SaleID||0)) : [];
             salesFiltered = salesData;
             wireSalesControls();
             renderSales();
         }
        function filterSales(){
            const q = document.getElementById('salesSearch')?.value?.toLowerCase() || '';
            salesFiltered = salesData.filter(s =>
                String(s.SaleID||'').includes(q) ||
                (s.ProductName||'').toLowerCase().includes(q) ||
                (s.CustomerName||'').toLowerCase().includes(q)
            );
            renderSales();
        }
        function renderSales(){
            if(!salesTableBody) return;
            if(salesFiltered.length===0){salesTableBody.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4">No sales recorded.</td></tr>'; return;}
            let t=''; salesFiltered.forEach(s=>{let d='Invalid';try{d=new Date(s.SaleDate).toLocaleString();}catch(e){} t+=`<tr><td>${s.SaleID}</td><td>${s.ProductName||'N/A'}</td><td>${s.CustomerName||'N/A'}</td><td>${s.QuantitySold}</td><td>${formatCurrency(s.TotalAmount)}</td><td>${d}</td></tr>`;}); salesTableBody.innerHTML=t;
        }
        async function openSaleModal() { /* ... */ const f=document.getElementById('saleForm'); if(!f)return; f.reset(); const pS=document.getElementById('saleProduct'), cS=document.getElementById('saleCustomer'); pS.innerHTML='<option value="">Loading...</option>'; cS.innerHTML='<option value="">Loading...</option>'; const m=document.getElementById('saleModal'); bootstrap.Modal.getOrCreateInstance(m).show(); try {await Promise.all([loadProductDropdown('saleProduct',true),loadCustomerDropdown('saleCustomer')]);} catch(e){showToast("Error loading form data.","error"); pS.innerHTML='<option value="">Error</option>'; cS.innerHTML='<option value="">Error</option>';}}
        async function loadProductDropdown(id, onlyInStock = false) { /* ... */
             const s=document.getElementById(id); if(!s)return; s.innerHTML='<option value="">Loading...</option>'; try {const p=await apiFetch(`${API_URL}/products`); let f=onlyInStock?p.filter(i=>i.Quantity>0):p; s.innerHTML='<option value="">Select Product</option>'; if(f.length===0)s.innerHTML=`<option value="" disabled>No products ${onlyInStock?'in stock':'available'}</option>`; else f.forEach(i=>s.innerHTML+=`<option value="${i.ProductID}">${i.ProductName} (Stock: ${i.Quantity})</option>`);} catch(e){console.error(`Err loading PDD ${id}:`,e); s.innerHTML='<option value="">Error</option>'; throw e;}
         }
        async function loadCustomerDropdown(id) { /* ... */
             const s=document.getElementById(id); if(!s)return; s.innerHTML='<option value="">Loading...</option>'; try {const c=await apiFetch(`${API_URL}/customers`); s.innerHTML='<option value="">Select Customer</option>'; if(c.length===0)s.innerHTML='<option value="" disabled>No customers</option>'; else c.forEach(i=>s.innerHTML+=`<option value="${i.CustomerID}">${i.CustomerName}</option>`);} catch(e){console.error(`Err loading CDD ${id}:`,e); s.innerHTML='<option value="">Error</option>'; throw e;}
         }
        async function loadSupplierDropdown(id) { /* ... */
             const s=document.getElementById(id); if(!s)return; s.innerHTML='<option value="">Loading...</option>';
             try {
                  const sup = await apiFetch(`${API_URL}/suppliers`);
                  s.innerHTML = '<option value="">Select Supplier</option>';
                  if (sup.length === 0) s.innerHTML = '<option value="" disabled>No suppliers</option>';
                  else sup.forEach(i => s.innerHTML += `<option value="${i.SupplierID}">${i.SupplierName}</option>`);
             } catch(e) {
                  console.error(`Err loading SDD ${id}:`, e);
                  s.innerHTML = '<option value="">Error</option>';
                  throw e;
             }
         }
        async function saveSale() { /* ... */
             const f=document.getElementById('saleForm'); const pV=document.getElementById('saleProduct').value, cV=document.getElementById('saleCustomer').value, qV=parseInt(document.getElementById('saleQuantity').value); if(!f.checkValidity()||!pV||!cV||qV<=0){f.reportValidity();showToast('Select product, customer, valid qty > 0.','warning');return;} const d={ProductID:parseInt(pV),CustomerID:parseInt(cV),QuantitySold:qV}; const b=document.querySelector('#saleModal .btn-primary'); const o=b.innerHTML; b.disabled=true; b.innerHTML=`<span class="spinner-border spinner-border-sm"></span> Saving...`; try {await apiFetch(`${API_URL}/sales`,{method:'POST',body:d}); bootstrap.Modal.getInstance(document.getElementById('saleModal')).hide(); showToast('Sale recorded!','success'); await loadSales(); if(document.getElementById('dashboard-section').classList.contains('active')) await loadDashboard(); if(document.getElementById('products-section').classList.contains('active')) await loadProducts();} catch(e){showToast(`Save failed: ${e.message}`,'error');} finally {b.disabled=false; b.innerHTML=o;}
         }

        // --- Purchases (Read, Create + Search) ---
        let purchasesData = [];
        let purchasesFiltered = [];
        const purchasesTableBody = document.getElementById('purchasesTable');
        let purchasesControlsWired = false;
        function wirePurchasesControls(){ if(purchasesControlsWired) return; const s=document.getElementById('purchasesSearch'); if(s) s.addEventListener('input', filterPurchases); purchasesControlsWired = true; }
        function renderPurchaseSkeleton() { /* ... */ if(!purchasesTableBody)return; let s=''; for(let i=0;i<3;i++)s+=`<tr><td colspan="7"><div class="skeleton my-2" style="height:20px"></div></td></tr>`; purchasesTableBody.innerHTML=s;}
        async function loadPurchases() { /* ... */
             renderPurchaseSkeleton();
             purchasesData = await apiFetch(`${API_URL}/purchases`); // Propagates error
             purchasesData = Array.isArray(purchasesData) ? purchasesData.slice().sort((a,b) => (a?.PurchaseID||0) - (b?.PurchaseID||0)) : [];
             purchasesFiltered = purchasesData;
             wirePurchasesControls();
             renderPurchases();
         }
        function filterPurchases(){
            const q = document.getElementById('purchasesSearch')?.value?.toLowerCase() || '';
            purchasesFiltered = purchasesData.filter(p =>
                String(p.PurchaseID||'').includes(q) ||
                (p.ProductName||'').toLowerCase().includes(q) ||
                (p.SupplierName||'').toLowerCase().includes(q)
            );
            renderPurchases();
        }
        function renderPurchases(){
            if(!purchasesTableBody) return;
            if(purchasesFiltered.length===0){purchasesTableBody.innerHTML='<tr><td colspan="7" class="text-center text-muted py-4">No purchases recorded.</td></tr>'; return;}
            let t=''; purchasesFiltered.forEach(p=>{let d='Invalid';try{d=new Date(p.PurchaseDate).toLocaleString();}catch(e){} t+=`<tr><td>${p.PurchaseID}</td><td>${p.ProductName||'N/A'}</td><td>${p.SupplierName||'N/A'}</td><td>${p.QuantityPurchased}</td><td>${formatCurrency(p.UnitCost)}</td><td>${formatCurrency(p.TotalCost)}</td><td>${d}</td></tr>`;}); purchasesTableBody.innerHTML=t;
        }
        async function openPurchaseModal() { /* ... */ const f=document.getElementById('purchaseForm'); if(!f)return; f.reset(); const pS=document.getElementById('purchaseProduct'), sS=document.getElementById('purchaseSupplier'); pS.innerHTML='<option value="">Loading...</option>'; sS.innerHTML='<option value="">Loading...</option>'; const m=document.getElementById('purchaseModal'); bootstrap.Modal.getOrCreateInstance(m).show(); try {await Promise.all([loadProductDropdown('purchaseProduct',false),loadSupplierDropdown('purchaseSupplier')]);} catch(e){showToast("Error loading form data.","error"); pS.innerHTML='<option value="">Error</option>'; sS.innerHTML='<option value="">Error</option>';}}
        async function savePurchase() { /* ... */
             const f=document.getElementById('purchaseForm'); const pV=document.getElementById('purchaseProduct').value, sV=document.getElementById('purchaseSupplier').value, qV=parseInt(document.getElementById('purchaseQuantity').value), costV=parseFloat(document.getElementById('purchaseCost').value); if(!f.checkValidity()||!pV||!sV||qV<=0||costV<=0){f.reportValidity();showToast('Select product, supplier, valid qty/cost > 0.','warning');return;} const d={ProductID:parseInt(pV),SupplierID:parseInt(sV),QuantityPurchased:qV,UnitCost:costV}; const b=document.querySelector('#purchaseModal .btn-primary'); const o=b.innerHTML; b.disabled=true; b.innerHTML=`<span class="spinner-border spinner-border-sm"></span> Saving...`; try {await apiFetch(`${API_URL}/purchases`,{method:'POST',body:d}); bootstrap.Modal.getInstance(document.getElementById('purchaseModal')).hide(); showToast('Purchase recorded!','success'); await loadPurchases(); if(document.getElementById('dashboard-section').classList.contains('active')) await loadDashboard(); if(document.getElementById('products-section').classList.contains('active')) await loadProducts();} catch(e){showToast(`Save failed: ${e.message}`,'error');} finally {b.disabled=false; b.innerHTML=o;}
         }

        // --- Reports ---
        async function loadReport(reportType) {
            const contentDiv = document.getElementById('reportContent');
            const titleEl = document.getElementById('reportTitle');
            if(!contentDiv || !titleEl) return;

            contentDiv.innerHTML = `<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            titleEl.textContent = 'Loading Report...';
            
            document.querySelectorAll('#reports-section .btn-outline-primary').forEach(b => b.classList.remove('active'));
            const activeButton = document.querySelector(`#reports-section .btn[onclick="loadReport('${reportType}')"]`);
            if(activeButton) activeButton.classList.add('active');

            try {
                let url, title, chartType = 'bar', chartOptions = {};
                switch(reportType) {
                    case 'TopProducts': url = `${API_URL}/reports/top-products`; title = 'Top Selling Products (Top 10)'; chartType = 'bar'; break;
                    case 'LowStock': url = `${API_URL}/reports/low-stock`; title = 'Low Stock Products'; chartType = 'bar'; chartOptions = { indexAxis: 'y', plugins: { legend: { display: false } } }; break;
                    case 'SalesSummary': url = `${API_URL}/reports/sales-summary`; title = 'Daily Sales Summary (Last 30 Days)'; chartType = 'line'; chartOptions = { scales: { x: { reverse: true }}}; break;
                    default: throw new Error(`Unknown report type: ${reportType}`);
                }
                
                const data = await apiFetch(url); // Propagates error
                titleEl.textContent = title;
                
                if (!Array.isArray(data) || data.length === 0) {
                     contentDiv.innerHTML = '<p class="text-muted text-center py-4">No data available for this report.</p>';
                     if(reportChart) { reportChart.destroy(); reportChart = null; } return;
                 }
                
                contentDiv.innerHTML = `
                    <div class="row g-3">
                         <div class="col-lg-6" style="min-height: 320px; height: 360px; position: relative;">
                              <canvas id="reportChart"></canvas>
                         </div>
                         <div class="col-lg-6">
                              <div class="table-responsive" style="max-height: 400px;">
                                   <table class="table table-sm table-striped table-hover align-middle mb-0" id="reportTable"></table>
                              </div>
                         </div>
                    </div>`;

                // Build table
                let tableHTML = '<thead><tr>'; const headers = Object.keys(data[0]); headers.forEach(key => tableHTML += `<th>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</th>`); tableHTML += '</tr></thead><tbody>';
                data.forEach(row => { tableHTML += '<tr>'; headers.forEach(key => { let v=row[key], c=v??'N/A'; if(key.match(/amount|price|cost|revenue|sales/i)&&typeof v==='number')c=formatCurrency(v); else if(key.match(/date/i))try{c=new Date(v).toLocaleDateString();}catch(e){} else if(key==='Quantity'&&reportType==='LowStock')c=`<span class="badge bg-danger">${v}</span>`; tableHTML+=`<td>${c}</td>`; }); tableHTML+='</tr>'; }); tableHTML+='</tbody>';
                const reportTableEl = document.getElementById('reportTable'); if(reportTableEl) reportTableEl.innerHTML = tableHTML;

                // Chart rendering
                const ctx = document.getElementById('reportChart')?.getContext('2d');
                if (ctx) {
                     const isDark = document.body.getAttribute('data-theme') === 'dark';
                     const pC = isDark?'rgba(138,180,248,0.75)':'rgba(94,80,249,0.75)', sC=isDark?'rgba(45,212,191,0.65)':'rgba(6,214,160,0.65)', dC=isDark?'rgba(248,113,113,0.75)':'rgba(239,71,111,0.75)';
                     let chartData = { labels: [], datasets: [] };
                     if(reportType==='TopProducts'){chartData.labels=data.map(d=>d.ProductName).slice(0,10); chartData.datasets=[{label:'Units Sold',data:data.map(d=>d.TotalSold).slice(0,10),backgroundColor:pC},{label:'Revenue ()',data:data.map(d=>d.Revenue).slice(0,10),backgroundColor:sC}];}
                     else if(reportType==='LowStock'){chartData.labels=data.map(d=>d.ProductName).slice(0,15); chartData.datasets=[{label:'Quantity Needed',data:data.map(d=>d.QuantityNeeded).slice(0,15),backgroundColor:dC}];}
                     else if(reportType==='SalesSummary'){const sD=data.slice().sort((a,b)=>new Date(a.SaleDate)-new Date(b.SaleDate)); chartData.labels=sD.map(d=>new Date(d.SaleDate).toLocaleDateString()); chartData.datasets=[{label:'Sales ()',data:sD.map(d=>d.TotalAmount),borderColor:pC,backgroundColor:pC.replace('0.75','0.2'),tension:.35,fill:true}];}
                     renderChart(ctx, chartType, chartData, chartOptions);
                } else console.error("Canvas element for chart not found.");

            } catch (error) {
                console.error(`Error loading report ${reportType}:`, error);
                titleEl.textContent = `Error Loading ${reportType}`;
                contentDiv.innerHTML = `<p class="text-danger text-center py-4">Failed to load report data: ${error.message}</p>`;
                 if(reportChart) { reportChart.destroy(); reportChart = null; }
            }
        }

        // Initialize on DOMContentLoaded
        window.addEventListener('DOMContentLoaded', () => {
            // Theme handled by IIFE
            
            // Auth + initial data
            const navUser = document.getElementById('navUserLabel');
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) logoutBtn.addEventListener('click', (e)=>{ e.preventDefault(); clearAuth(); if(navUser) navUser.textContent = 'Guest'; showToast('Logged out.','success'); try { window.location.href = '/'; } catch {} });

            const token = getAuthToken();
            if (!token) {
                try { window.location.href = '/'; return; } catch {}
            } else {
                if(navUser) navUser.textContent = 'Admin';
                loadDashboard().catch(err => {
                    console.error("Initial dashboard load failed:", err);
                    showToast(`Failed to load initial dashboard: ${err.message}`, "error");
                     const dashSection = document.getElementById('dashboard-section');
                     if (dashSection) dashSection.innerHTML = `<p class="text-danger text-center py-5">Could not load dashboard data. Please refresh the page.</p>`;
                });
            }

            // Load Chart.js script dynamically if not already loaded
            if (typeof Chart === 'undefined' && !document.querySelector('script[src*="chart.umd.min.js"]')) {
                 const chartScript = document.createElement('script');
                 chartScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js';
                 chartScript.async = true;
                 chartScript.onload = () => console.log("Chart.js loaded.");
                 chartScript.onerror = () => console.error("Failed to load Chart.js");
                 document.body.appendChild(chartScript);
            }

            // Enable Bootstrap tooltips (safer initialization)
             try {
                  // Initialize tooltips only on elements that don't already have one initialized
                 const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]:not([disabled]):not([data-bs-original-title])'));
                  tooltipTriggerList.forEach(tooltipTriggerEl => {
                      new bootstrap.Tooltip(tooltipTriggerEl);
                  });
             } catch(e) { console.warn("Error initializing tooltips:", e); }

            // Navbar shadow on scroll
            const nav = document.querySelector('.navbar');
            const onScroll = () => {
                if (!nav) return;
                if (window.scrollY > 4) nav.classList.add('scrolled'); else nav.classList.remove('scrolled');
            };
            onScroll();
            window.addEventListener('scroll', onScroll, { passive: true });

            // Sidebar off-canvas toggle (mobile)
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebar && sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                });
                // Close sidebar when clicking outside (mobile)
                document.addEventListener('click', (e) => {
                    if (window.innerWidth >= 992) return; // only mobile
                    if (!sidebar.classList.contains('open')) return;
                    const withinSidebar = sidebar.contains(e.target);
                    const isToggle = sidebarToggle.contains(e.target);
                    if (!withinSidebar && !isToggle) sidebar.classList.remove('open');
                });
            }

            // Real-time validation for all relevant fields
            const attachValidation = (el) => {
                if (!el) return;
                const validate = () => {
                    // Empty fields: no state until user enters something
                    const val = (el.value || '').trim();
                    if (val === '') { el.classList.remove('is-valid', 'is-invalid'); return; }
                    if (!el.checkValidity()) { el.classList.add('is-invalid'); el.classList.remove('is-valid'); }
                    else { el.classList.add('is-valid'); el.classList.remove('is-invalid'); }
                };
                el.addEventListener('input', validate);
                el.addEventListener('blur', validate);
                if (el.tagName === 'SELECT') el.addEventListener('change', validate);
            };
            document.querySelectorAll('#productForm input, #productForm textarea, #productForm select,\
                                       #supplierForm input, #supplierForm textarea, #supplierForm select,\
                                       #customerForm input, #customerForm textarea, #customerForm select,\
                                       #saleForm input, #saleForm select,\
                                       #purchaseForm input, #purchaseForm select')
                    .forEach(attachValidation);
            // Login handlers removed (using standalone login page)

        });

    </script>
</body>
</html>