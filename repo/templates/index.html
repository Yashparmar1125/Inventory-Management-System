<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Inventory Management System</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css"
        rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Premium Color Palette */
            --primary-color: #5B5FFF;
            --primary-color-rgb: 91, 95, 255;
            --primary-hover: #4A4EF5;
            --secondary-color: #7C3AED;
            --accent-color: #EC4899;
            --success-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --info-color: #0EA5E9;

            /* Neutral Palette */
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;

            /* Dark Mode Colors */
            --dark-color: #0A0E1A;
            --dark-surface: #0F1419;
            --dark-elevated: #1A1F2E;
            --dark-border: #262B3D;

            /* Semantic Colors */
            --light-bg: var(--gray-50);
            --white: #FFFFFF;
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-600);
            --text-tertiary: var(--gray-500);
            --border-color: var(--gray-200);
            --border-light: var(--gray-100);

            /* Premium Shadows */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.02);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.04), 0 1px 2px 0 rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.06), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);

            /* Ring/Focus Colors */
            --ring-color: rgba(91, 95, 255, 0.3);
            --ring-offset: 2px;

            --bs-primary: var(--primary-color);
            --bs-primary-rgb: var(--primary-color-rgb);

            --bs-border-radius: 0.625rem;
            --bs-border-radius-lg: 0.875rem;
            --bs-border-radius-xl: 1.25rem;
            --bs-box-shadow-sm: var(--shadow-sm);
            --bs-box-shadow: var(--shadow-md);
            --bs-box-shadow-lg: var(--shadow-lg);

            --bs-modal-border-radius: var(--bs-border-radius-lg);
            --bs-card-border-radius: var(--bs-border-radius-lg);
            --bs-card-border-width: 0;
            --bs-card-box-shadow: var(--bs-box-shadow);
        }

        body {
            background: var(--gray-50);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            position: relative;
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse at top right, rgba(91, 95, 255, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at bottom left, rgba(124, 58, 237, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        /* --- Premium Navbar --- */
        .navbar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            box-shadow: var(--shadow-sm);
            border-bottom: 1px solid var(--border-light);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            height: 60px;
            padding: 0 1.5rem;
            position: relative;
            z-index: 1030;
        }
        
        /* Dropdown Menu Improvements */
        .dropdown-menu {
            min-width: 200px;
            padding: 0.5rem 0;
            margin-top: 0.5rem;
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-xl);
            z-index: 1050;
        }
        
        .dropdown-item {
            padding: 0.625rem 1.25rem;
            font-size: 0.9375rem;
            color: var(--text-primary);
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .dropdown-item:hover {
            background: var(--gray-100);
            color: var(--primary-color);
        }
        
        .dropdown-item i {
            width: 1.25rem;
            font-size: 1.125rem;
        }
        
        .dropdown-divider {
            margin: 0.5rem 0;
            border-color: var(--border-light);
        }

        .navbar.scrolled {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: var(--shadow-md);
            border-bottom-color: var(--border-color);
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.125rem;
            letter-spacing: -0.02em;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .navbar-brand i {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .navbar-brand:hover {
            color: var(--primary-color);
            transform: translateX(2px);
        }

        .navbar-brand i {
            font-size: 1.75rem;
            margin-right: 0.5rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Ensure dark mode navbar links are visible */
        .navbar-dark .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.75);
        }

        .navbar-dark .navbar-nav .nav-link:hover,
        .navbar-dark .navbar-nav .nav-link:focus {
            color: rgba(255, 255, 255, 1);
        }

        .navbar-dark .dropdown-menu {
            background-color: var(--dark-surface);
            border-color: var(--dark-border);
        }

        .navbar-dark .dropdown-item {
            color: #e5e7eb;
        }

        .navbar-dark .dropdown-item:hover,
        .navbar-dark .dropdown-item:focus {
            background-color: rgba(138, 180, 248, 0.1);
            color: #fff;
        }


        /* --- Premium Sidebar --- */
        .sidebar {
            min-height: calc(100vh - 60px);
            background: var(--white);
            border-right: 1px solid var(--border-light);
            padding: 2rem 0.75rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 240px;
        }

        .sidebar .nav-link {
            color: var(--text-secondary);
            padding: 10px 14px;
            margin: 2px 0;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.9375rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .sidebar .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .sidebar .nav-link:hover {
            background: var(--gray-100);
            color: var(--text-primary);
            transform: translateX(2px);
        }

        .sidebar .nav-link:hover::before {
            transform: translateX(0);
        }

        .sidebar .nav-link.active {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            box-shadow: var(--shadow-md);
            transform: translateX(2px);
        }

        .sidebar .nav-link.active::before {
            transform: translateX(0);
            background: rgba(255, 255, 255, 0.3);
        }

        .sidebar .nav-link i {
            margin-right: 14px;
            width: 20px;
            font-size: 1.2rem;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .sidebar .nav-link:hover i {
            transform: scale(1.1);
        }

        /* --- Content Area --- */
        .content-area {
            padding: 2rem;
            background: transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: calc(100vh - 57px);
        }

        .page-section {
            display: none;
            /* Hide all sections initially */
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-section.active {
            display: block;
            /* Show active section */
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .page-header h2 {
            margin-bottom: 0;
            font-weight: 700;
        }

        /* --- Premium Stat Cards --- */
        .stat-card {
            background: var(--white);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--gray-300);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card .fs-1 {
            font-size: 2.75rem !important;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: transform 0.2s ease;
        }

        .stat-card:hover .fs-1 {
            transform: scale(1.05);
        }

        .stat-card h3 {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            color: var(--text-secondary);
            margin: 0;
            font-size: 0.9rem;
        }

        /* --- Premium Table Container --- */
        .table-container {
            background: var(--white);
            border-radius: 0.75rem;
            padding: 0;
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-light);
            overflow: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .table-container:hover {
            box-shadow: var(--shadow-md);
        }

        table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--gray-50);
            border-bottom: 1px solid var(--border-color);
            text-transform: none;
            font-size: 0.8125rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            color: var(--text-secondary);
            padding: 1rem 1.5rem;
            vertical-align: middle;
            white-space: nowrap;
        }

        table tbody tr {
            border-bottom: 1px solid var(--border-light);
            transition: background-color 0.15s ease;
        }

        table tbody tr:last-child {
            border-bottom: 0;
        }

        table tbody tr:hover {
            background: var(--gray-50);
        }

        table th,
        table td {
            padding: 1rem 1.5rem;
            vertical-align: middle;
            border: none;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        table td {
            color: var(--text-secondary);
        }

        /* Table Action Buttons */
        table .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: var(--bs-border-radius);
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: hidden;
        }

        table .btn-sm::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }

        table .btn-sm:hover::before {
            width: 100px;
            height: 100px;
        }

        table .btn {
            margin: 0 3px;
        }

        table .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .table-sm th,
        .table-sm td {
            padding: 1rem 0.75rem;
        }

        /* --- Responsive Tweaks --- */
        @media (max-width: 991.98px) {
            .content-area {
                padding: 1rem;
            }

            .page-header {
                flex-wrap: wrap;
                gap: .75rem;
            }

            .table-container {
                padding: 1rem;
            }

            /* Off-canvas sidebar */
            .sidebar {
                position: fixed;
                top: 57px;
                left: 0;
                height: calc(100vh - 57px);
                width: 260px;
                z-index: 1040;
                background-color: #fff;
                transform: translateX(-100%);
                box-shadow: var(--bs-box-shadow-lg);
                transition: transform .3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .content-area {
                margin-left: 0 !important;
            }
        }

        @media (max-width: 575.98px) {

            table th,
            table td {
                padding: .75rem .5rem;
            }

            .stat-card .fs-1 {
                font-size: 2rem !important;
            }

            .stat-card {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .table-container {
                padding: 1rem;
                margin-bottom: 1.5rem;
            }

            .content-area {
                padding: 1rem;
            }

            .page-header h2 {
                font-size: 1.5rem;
            }

            .sidebar {
                width: 280px;
            }

            .modal-content {
                margin: 1rem;
            }

            .modal-header {
                padding: 1.5rem 1.5rem 1rem;
            }

            .modal-body {
                padding: 1rem 1.5rem 1.5rem;
            }

            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .btn-sm {
                padding: 0.375rem 0.75rem;
                font-size: 0.8rem;
            }
        }

        /* Enhanced tablet responsiveness */
        @media (max-width: 991.98px) and (min-width: 768px) {
            .content-area {
                padding: 1.5rem;
            }

            .table-container {
                padding: 1.5rem;
            }

            .stat-card {
                padding: 2rem;
            }

            .sidebar {
                width: 240px;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #000000;
                --text-secondary: #000000;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            }

            .btn,
            .stat-card,
            .table-container {
                border: 2px solid var(--text-primary);
            }
        }

        /* --- Buttons --- */
        .btn {
            border-radius: var(--bs-border-radius);
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: hidden;
            text-transform: none;
            letter-spacing: 0.3px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
            z-index: 0;
        }

        .btn:hover::before {
            width: 120px;
            height: 120px;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            box-shadow: var(--shadow-xs);
            color: white;
            font-weight: 500;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-inner);
        }

        .btn-success {
            background: var(--success-color);
            border: none;
            color: white;
            font-weight: 500;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--danger-color);
            border: none;
            color: white;
            font-weight: 500;
        }

        .btn-danger:hover {
            background: #DC2626;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: var(--warning-color);
            border: none;
            color: white;
            font-weight: 500;
        }

        .btn-warning:hover {
            background: #D97706;
            transform: translateY(-1px);
        }

        .btn-outline-primary {
            border: 1.5px solid var(--border-color);
            color: var(--text-primary);
            background: transparent;
            font-weight: 500;
        }

        .btn-outline-primary:hover {
            border-color: var(--primary-color);
            background: rgba(var(--primary-color-rgb), 0.06);
            color: var(--primary-color);
            transform: translateY(-1px);
        }
        

        .btn:focus-visible {
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(var(--primary-color-rgb), 0.35);
        }

        .btn-primary {
            box-shadow: 0 2px 6px rgba(var(--primary-color-rgb), 0.3);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            box-shadow: 0 4px 10px rgba(var(--primary-color-rgb), 0.4);
            transform: translateY(-1px);
        }

        /* Report buttons active state */
        #reports-section .btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 6px rgba(var(--primary-color-rgb), 0.3);
        }

        /* --- Premium Forms --- */
        .form-control,
        .form-select {
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--white);
            font-size: 0.875rem;
            padding: 0.625rem 0.875rem;
            color: var(--text-primary);
        }

        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 3px var(--ring-color);
            border-color: var(--primary-color);
            outline: none;
        }

        .form-control::placeholder {
            color: var(--gray-400);
        }

        .form-control:focus-visible,
        .form-select:focus-visible {
            outline: none;
        }

        .form-floating>.form-control,
        .form-floating>.form-select {
            border-radius: var(--bs-border-radius);
        }

        .form-floating label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-floating .form-control:focus~label,
        .form-floating .form-control:not(:placeholder-shown)~label {
            color: var(--primary-color);
        }

        /* --- Premium Modals --- */
        .modal-content {
            border: 1px solid var(--border-light);
            border-radius: 1rem;
            box-shadow: var(--shadow-2xl);
            background: var(--white);
            animation: modalFadeIn 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-backdrop {
            backdrop-filter: blur(4px);
            background-color: rgba(0, 0, 0, 0.4);
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            border-bottom: 1px solid var(--border-light);
            padding: 1.5rem 1.5rem;
            background: var(--white);
        }

        .modal-header .modal-title {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.125rem;
            letter-spacing: -0.01em;
        }

        .modal-header .btn-close {
            opacity: 0.5;
        }

        .modal-header .btn-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            border-top: 0;
            padding: 0 1.5rem 1.5rem;
        }

        /* --- Skeletons & Loaders --- */
        /* REMOVED: #loadingOverlay styles as it's no longer used globally */
        .loader {
            display: flex;
            gap: 10px;
            margin: 2rem auto;
            justify-content: center;
        }

        /* Center if used standalone */
        .loader .dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: var(--primary-color);
            animation: bounce 0.6s infinite alternate;
        }

        .loader .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loader .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(-10px);
            }
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e6e6e6 37%, #f0f0f0 63%);
            background-size: 400% 100%;
            animation: shimmer 1.4s ease infinite;
            border-radius: 4px;
            min-height: 14px;
            /* Use min-height */
            width: 100%;
            /* Ensure full width */
            display: inline-block;
        }

        .skeleton.w-75 {
            width: 75% !important;
        }

        .skeleton.w-50 {
            width: 50% !important;
        }

        .skeleton.w-25 {
            width: 25% !important;
        }

        @keyframes shimmer {
            0% {
                background-position: 100% 0;
            }

            100% {
                background-position: -100% 0;
            }

            /* Adjusted for smoother loop */
        }

        /* --- Toast --- */
        .toast {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* --- Dark Mode --- */
        body[data-theme="dark"] {
            --primary-color: #8ab4f8;
            --primary-color-rgb: 138, 180, 248;
            --secondary-color: #669df6;
            --success-color: #2dd4bf;
            --danger-color: #f87171;
            --warning-color: #fbbf24;

            background-color: var(--dark-color);
            color: #e5e7eb;

            --bs-body-color: #e5e7eb;
            --bs-body-bg: var(--dark-color);
            --bs-emphasis-color: #fff;
            --bs-secondary-color: rgba(229, 231, 235, 0.75);
            --bs-secondary-bg: var(--dark-surface);
            --bs-tertiary-color: rgba(229, 231, 235, 0.5);
            --bs-tertiary-bg: #1f2937;
            --bs-border-color: var(--dark-border);
            --bs-border-color-translucent: rgba(255, 255, 255, 0.15);
            --bs-heading-color: #fff;

            /* Dark Form Controls */
            --bs-form-control-bg: var(--dark-surface);
            --bs-form-select-bg: var(--dark-surface);
            --bs-input-group-addon-bg: var(--dark-surface);
            --bs-input-disabled-bg: #1f2937;
            --bs-input-color: #e5e7eb;
            --bs-input-border-color: var(--dark-border);
            --bs-input-placeholder-color: #9ca3af;
        }

        body[data-theme="dark"] .navbar {
            background: var(--dark-surface);
            border-bottom-color: var(--dark-border);
        }

        body[data-theme="dark"] .navbar-brand {
            color: var(--primary-color);
        }

        body[data-theme="dark"] .sidebar {
            background-color: var(--dark-surface);
            border-right-color: var(--dark-border);
        }

        body[data-theme="dark"] .sidebar .nav-link {
            color: #cbd5e1;
        }

        body[data-theme="dark"] .sidebar .nav-link:hover {
            background-color: rgba(138, 180, 248, 0.1);
            color: var(--primary-color);
        }

        body[data-theme="dark"] .sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: var(--dark-color);
            /* High contrast */
            box-shadow: 0 4px 10px rgba(var(--primary-color-rgb), 0.2);
        }

        body[data-theme="dark"] .content-area {
            background-color: var(--dark-color);
        }

        body[data-theme="dark"] .stat-card {
            box-shadow: none;
            border: 1px solid var(--dark-border);
        }

        body[data-theme="dark"] .table-container {
            background: var(--dark-surface);
            box-shadow: none;
            border: 1px solid var(--dark-border);
        }

        body[data-theme="dark"] table thead th {
            background: var(--dark-surface);
            color: #9ca3af;
            border-bottom-color: var(--dark-border);
        }

        body[data-theme="dark"] table tbody tr {
            border-bottom-color: var(--dark-border);
        }

        body[data-theme="dark"] table tbody tr:hover {
            background-color: rgba(138, 180, 248, 0.1);
        }

        body[data-theme="dark"] .modal-content {
            background: var(--dark-surface);
            color: #e5e7eb;
            border: 1px solid var(--dark-border);
            box-shadow: none;
        }

        body[data-theme="dark"] .modal-header .btn-close {
            filter: invert(1) brightness(2);
        }

        body[data-theme="dark"] .btn-primary {
            box-shadow: 0 2px 6px rgba(var(--primary-color-rgb), 0.2);
        }

        body[data-theme="dark"] .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        body[data-theme="dark"] .btn-outline-primary:hover {
            background: rgba(var(--primary-color-rgb), 0.1);
            color: var(--primary-color);
        }

        body[data-theme="dark"] #reports-section .btn.active {
            background-color: var(--primary-color);
            color: var(--dark-color);
            border-color: var(--primary-color);
        }

        body[data-theme="dark"] .btn-secondary {
            --bs-btn-color: #e5e7eb;
            --bs-btn-bg: #374151;
            --bs-btn-border-color: #374151;
            --bs-btn-hover-color: #fff;
            --bs-btn-hover-bg: #4b5563;
            --bs-btn-hover-border-color: #4b5563;
        }

        /* REMOVED: #loadingOverlay dark styles */

        body[data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, #1f2937 25%, #374151 37%, #1f2937 63%);
            background-size: 400% 100%;
        }

        /* Improve floating label appearance in dark mode */
        body[data-theme="dark"] .form-floating>.form-control:-webkit-autofill,
        body[data-theme="dark"] .form-floating>.form-control:-webkit-autofill:hover,
        body[data-theme="dark"] .form-floating>.form-control:-webkit-autofill:focus,
        body[data-theme="dark"] .form-floating>.form-control:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px var(--dark-surface) inset !important;
            -webkit-text-fill-color: #e5e7eb !important;
            caret-color: #e5e7eb;
            /* Add this line */
        }

        body[data-theme="dark"] .form-floating>label {
            color: #9ca3af;
            /* Adjust label color for better contrast */
        }

        body[data-theme="dark"] .form-floating>.form-control:focus~label,
        body[data-theme="dark"] .form-floating>.form-control:not(:placeholder-shown)~label,
        body[data-theme="dark"] .form-floating>.form-select~label {
            color: var(--primary-color);
            /* Color when active/floated */
        }

        /* --- Advanced UI/UX Enhancements --- */

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            color: var(--border-color);
            margin-bottom: 1.5rem;
            opacity: 0.6;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .empty-state p {
            font-size: 1rem;
            margin-bottom: 1.5rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Enhanced Search Bar */
        .search-wrapper {
            position: relative;
            max-width: 400px;
        }

        .search-wrapper .form-control {
            padding-left: 2.75rem;
            padding-right: 2.75rem;
            border-radius: 2rem;
            transition: all 0.3s ease;
        }

        .search-wrapper .form-control:focus {
            box-shadow: 0 0 0 4px rgba(var(--primary-color-rgb), 0.1);
            border-color: var(--primary-color);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        .search-clear {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .search-clear:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        /* Tooltips */
        .tooltip-trigger {
            position: relative;
            cursor: help;
        }

        .custom-tooltip {
            position: absolute;
            background: var(--dark-surface);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: var(--bs-border-radius);
            font-size: 0.875rem;
            white-space: nowrap;
            z-index: 1070;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            box-shadow: var(--shadow-lg);
        }

        .tooltip-trigger:hover .custom-tooltip {
            opacity: 1;
        }

        /* Progress Indicators */
        .progress-modern {
            height: 0.5rem;
            border-radius: 1rem;
            background: var(--border-color);
            overflow: hidden;
            position: relative;
        }

        .progress-modern .progress-bar {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            height: 100%;
            border-radius: 1rem;
            transition: width 0.6s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-modern .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.3),
                    transparent);
            animation: shimmer 2s infinite;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 20px 40px -10px rgba(var(--primary-color-rgb), 0.4);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Enhanced Pagination */
        .pagination-modern {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: center;
            margin-top: 2rem;
        }

        .pagination-modern .page-btn {
            min-width: 40px;
            height: 40px;
            border-radius: var(--bs-border-radius);
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .pagination-modern .page-btn:hover:not(.active):not(:disabled) {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: rgba(var(--primary-color-rgb), 0.05);
        }

        .pagination-modern .page-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-color: transparent;
        }

        .pagination-modern .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Badge Enhancements */
        .badge-modern {
            padding: 0.375rem 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .badge-success {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }

        .badge-warning {
            background: linear-gradient(135deg, #F59E0B, #D97706);
            color: white;
        }

        .badge-danger {
            background: linear-gradient(135deg, #EF4444, #DC2626);
            color: white;
        }

        .badge-info {
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
        }

        /* Card Hover Effects */
        .card-hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        /* Smooth Scroll */
        html {
            scroll-behavior: smooth;
        }

        /* Selection Styling */
        ::selection {
            background: rgba(var(--primary-color-rgb), 0.2);
            color: var(--text-primary);
        }

        /* Focus Visible */
        *:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
            border-radius: 2px;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Loading Spinner */
        .spinner-modern {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Pulse Animation for Notifications */
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Slide In Animation */
        .slide-in {
            animation: slideInFromRight 0.5s ease-out;
        }

        @keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Status Indicators */
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-dot.success {
            background: var(--success-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .status-dot.warning {
            background: var(--warning-color);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }

        .status-dot.danger {
            background: var(--danger-color);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        /* Dark Mode Adjustments for New Elements */
        body[data-theme="dark"] .empty-state-icon {
            color: var(--dark-border);
        }

        body[data-theme="dark"] .search-wrapper .form-control {
            background: var(--dark-surface);
            border-color: var(--dark-border);
            color: #e5e7eb;
        }

        body[data-theme="dark"] .pagination-modern .page-btn {
            background: var(--dark-surface);
            border-color: var(--dark-border);
            color: #e5e7eb;
        }

        body[data-theme="dark"] ::-webkit-scrollbar-track {
            background: var(--dark-surface);
        }

        body[data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: var(--dark-border);
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="bi bi-box-seam"></i>
                <span>Smart Inventory</span>
            </a>
            <div class="d-flex align-items-center gap-2">
                <button id="sidebarToggle" class="btn btn-outline-primary btn-sm d-lg-none" type="button"
                    aria-label="Toggle sidebar">
                    <i class="bi bi-list"></i>
                </button>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-label="Toggle navigation">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="bi bi-bell me-1"></i> Notifications</a>
                    </li>
                    <li class="nav-item mx-2">
                        <button id="themeToggle" class="btn btn-sm d-flex align-items-center" title="Toggle theme">
                            <i class="bi bi-moon-fill"></i>
                        </button>
                    </li>
                    <li class="nav-item dropdown d-none" id="userMenu">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle me-1"></i> <span id="navUserLabel"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#" id="openProfile"><i
                                        class="bi bi-person-fill me-2"></i> Profile</a></li>
                            <li><a class="dropdown-item" href="#" id="openSettings"><i class="bi bi-gear me-2"></i>
                                    Settings</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn"><i
                                        class="bi bi-box-arrow-right me-2"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 sidebar">
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#" data-page="dashboard">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                    <a class="nav-link" href="#" data-page="products">
                        <i class="bi bi-box"></i> Products
                    </a>
                    <a class="nav-link" href="#" data-page="suppliers">
                        <i class="bi bi-truck"></i> Suppliers
                    </a>
                    <a class="nav-link" href="#" data-page="customers">
                        <i class="bi bi-people"></i> Customers
                    </a>
                    <a class="nav-link" href="#" data-page="sales">
                        <i class="bi bi-cart-check"></i> Sales
                    </a>
                    <a class="nav-link" href="#" data-page="purchases">
                        <i class="bi bi-bag-plus"></i> Purchases
                    </a>
                    <a class="nav-link" href="#" data-page="reports">
                        <i class="bi bi-graph-up"></i> Reports
                    </a>
                </nav>
            </div>

            <div class="col-md-10 content-area">

                <div id="dashboard-section" class="page-section active">
                    <div class="page-header">
                        <h2>Dashboard Overview</h2>
                    </div>

                    <div class="row">
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card card border-0" style="background-color: var(--bs-primary-bg-subtle);"
                                onclick="navigateToPage('products')">
                                <div class="card-body d-flex align-items-center">
                                    <i class="bi bi-box fs-1 text-primary me-3"></i>
                                    <div>
                                        <h3 id="totalProducts" class="fw-bold text-primary-emphasis">...</h3>
                                        <p class="mb-0 text-primary-emphasis opacity-75">Total Products</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card card border-0" style="background-color: var(--bs-success-bg-subtle);"
                                onclick="navigateToPage('sales')">
                                <div class="card-body d-flex align-items-center">
                                    <i class="bi bi-currency-rupee fs-1 text-success me-3"></i>
                                    <div>
                                        <h3 id="totalSales" class="fw-bold text-success-emphasis">...</h3>
                                        <p class="mb-0 text-success-emphasis opacity-75">Total Sales</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card card border-0" style="background-color: var(--bs-warning-bg-subtle);"
                                onclick="navigateToPage('reports', 'LowStock')">
                                <div class="card-body d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle fs-1 text-warning me-3"></i>
                                    <div>
                                        <h3 id="lowStockCount" class="fw-bold text-warning-emphasis">...</h3>
                                        <p class="mb-0 text-warning-emphasis opacity-75">Low Stock Items</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-card card border-0" style="background-color: var(--bs-info-bg-subtle);"
                                onclick="navigateToPage('customers')">
                                <div class="card-body d-flex align-items-center">
                                    <i class="bi bi-people fs-1 text-info me-3"></i>
                                    <div>
                                        <h3 id="totalCustomers" class="fw-bold text-info-emphasis">...</h3>
                                        <p class="mb-0 text-info-emphasis opacity-75">Total Customers</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="table-container">
                                <h5 class="mb-3"><i class="bi bi-exclamation-circle text-danger me-2"></i>Low Stock
                                    Alerts</h5>
                                <div id="lowStockAlerts">
                                    <div class="skeleton mb-2" style="height: 18px;"></div>
                                    <div class="skeleton w-75 mb-2" style="height: 18px;"></div>
                                    <div class="skeleton w-50" style="height: 18px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="products-section" class="page-section">
                    <div class="page-header">
                        <h2>Products Management</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal"
                            onclick="openProductModal()">
                            <i class="bi bi-plus-circle me-1"></i> Add Product
                        </button>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <input id="productSearch" type="search" class="form-control"
                                placeholder="Search by name or category..." />
                        </div>
                        <div class="col-md-3">
                            <select id="productPageSize" class="form-select">
                                <option value="5">5 / page</option>
                                <option value="10" selected>10 / page</option>
                                <option value="20">20 / page</option>
                            </select>
                        </div>
                        <div class="col-md-3 text-md-end pt-2">
                            <span id="productCount" class="text-muted small"></span>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Supplier</th>
                                    <th>Status</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTable">
                                <tr>
                                    <td colspan="8">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="8">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="8">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="8">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="8">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <nav class="d-flex justify-content-end align-items-center">
                            <ul id="productPagination" class="pagination mb-0"></ul>
                        </nav>
                    </div>
                </div>

                <div id="suppliers-section" class="page-section">
                    <div class="page-header">
                        <h2>Suppliers Management</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#supplierModal"
                            onclick="openSupplierModal()">
                            <i class="bi bi-plus-circle me-1"></i> Add Supplier
                        </button>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <input id="supplierSearch" type="search" class="form-control"
                                placeholder="Search by name, contact, phone, or email..." />
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Contact Person</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="suppliersTable">
                                <tr>
                                    <td colspan="6">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="6">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="6">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="customers-section" class="page-section">
                    <div class="page-header">
                        <h2>Customers Management</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customerModal"
                            onclick="openCustomerModal()">
                            <i class="bi bi-plus-circle me-1"></i> Add Customer
                        </button>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <input id="customerSearch" type="search" class="form-control"
                                placeholder="Search by name, phone, email, or address..." />
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Email</th>
                                    <th>Address</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customersTable">
                                <tr>
                                    <td colspan="6">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="6">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="6">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="sales-section" class="page-section">
                    <div class="page-header">
                        <h2>Sales Transactions</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saleModal"
                            onclick="openSaleModal()">
                            <i class="bi bi-plus-circle me-1"></i> Record Sale
                        </button>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <input id="salesSearch" type="search" class="form-control"
                                placeholder="Search by sale id, product, or customer..." />
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Sale ID</th>
                                    <th>Product</th>
                                    <th>Customer</th>
                                    <th>Quantity</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="salesTable">
                                <tr>
                                    <td colspan="6">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="6">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="6">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="purchases-section" class="page-section">
                    <div class="page-header">
                        <h2>Purchase Transactions</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#purchaseModal"
                            onclick="openPurchaseModal()">
                            <i class="bi bi-plus-circle me-1"></i> Record Purchase
                        </button>
                    </div>
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <input id="purchasesSearch" type="search" class="form-control"
                                placeholder="Search by purchase id, product, or supplier..." />
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Purchase ID</th>
                                    <th>Product</th>
                                    <th>Supplier</th>
                                    <th>Quantity</th>
                                    <th>Unit Cost</th>
                                    <th>Total Cost</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="purchasesTable">
                                <tr>
                                    <td colspan="7">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="7">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="7">
                                        <div class="skeleton my-2"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="reports-section" class="page-section">
                    <div class="page-header">
                        <h2>Reports & Analytics</h2>
                    </div>

                    <div class="row gy-2 gx-2 mb-3 align-items-end">
                        <div class="col-12 col-md-6 col-lg-4">
                            <div class="btn-group w-100" role="group" aria-label="Report Switcher">
                                <button class="btn btn-outline-primary" onclick="loadReport('TopProducts')"><i
                                        class="bi bi-trophy me-1"></i>Top Products</button>
                                <button class="btn btn-outline-primary" onclick="loadReport('LowStock')"><i
                                        class="bi bi-exclamation-triangle me-1"></i>Low Stock</button>
                                <button class="btn btn-outline-primary" onclick="loadReport('SalesSummary')"><i
                                        class="bi bi-graph-up me-1"></i>Sales</button>
                            </div>
                        </div>
                        <div class="col-6 col-md-3 col-lg-2">
                            <label class="form-label mb-1 small">Chart</label>
                            <select id="reportChartType" class="form-select form-select-sm">
                                <option value="bar">Bar</option>
                                <option value="line">Line</option>
                                <option value="pie">Pie</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-3 col-lg-2 d-none" id="reportFromWrap">
                            <label class="form-label mb-1 small">From</label>
                            <input type="date" id="reportFrom" class="form-control form-control-sm">
                        </div>
                        <div class="col-6 col-md-3 col-lg-2 d-none" id="reportToWrap">
                            <label class="form-label mb-1 small">To</label>
                            <input type="date" id="reportTo" class="form-control form-control-sm">
                        </div>
                        <div class="col-6 col-md-3 col-lg-2 text-md-end">
                            <button id="exportReportBtn" class="btn btn-outline-secondary w-100"><i
                                    class="bi bi-download me-1"></i>Export CSV</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <h5 id="reportTitle" class="mb-3">Select a report to view</h5>
                        <div id="reportSummary" class="row g-3 mb-3"></div>
                        <div id="reportContent">
                            <p class="text-muted">Report data and chart will appear here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 2100;">
        <div id="toastContainer"></div>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileModalLabel">Your Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="profileForm">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="profileUsername" placeholder="Username"
                                        readonly>
                                    <label for="profileUsername">Username</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="email" class="form-control" id="profileEmail" placeholder="Email">
                                    <label for="profileEmail">Email</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="profileFullName" placeholder="Full name">
                            <label for="profileFullName">Full name</label>
                        </div>
                        <div class="form-floating">
                            <textarea class="form-control" id="profileBio" placeholder="Bio"
                                style="height: 100px"></textarea>
                            <label for="profileBio">Bio</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveProfileBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="settingsForm">
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Default Products Page Size</label>
                                <select id="setPageSize" class="form-select">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Default Report Chart</label>
                                <select id="setChartType" class="form-select">
                                    <option value="bar">Bar</option>
                                    <option value="line">Line</option>
                                    <option value="pie">Pie</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="setDarkMode">
                            <label class="form-check-label" for="setDarkMode">Use Dark Mode</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveSettingsBtn">Save</button>
                </div>
            </div>
        </div>
    </div>



    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Add Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="productId">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="productName" placeholder="Product Name" required
                                pattern="^[A-Za-z][A-Za-z\s'\-.]{1,}$" inputmode="text" maxlength="100"
                                autocomplete="off" aria-describedby="productNameFeedback">
                            <label for="productName">Product Name *</label>
                            <div id="productNameFeedback" class="invalid-feedback">Enter a valid name: letters, spaces,
                                apostrophes, hyphens, dots; min 2 chars.</div>
                        </div>
                        <div class="form-floating mb-3">
                            <textarea class="form-control" id="productDescription" placeholder="Description"
                                style="height: 100px" maxlength="300"
                                aria-describedby="productDescriptionFeedback"></textarea>
                            <label for="productDescription">Description</label>
                            <div id="productDescriptionFeedback" class="invalid-feedback">Max 300 characters.</div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="productCategory" placeholder="Category"
                                pattern="^[A-Za-z][A-Za-z\s'\-/\.]{1,}$" inputmode="text" maxlength="60"
                                aria-describedby="productCategoryFeedback">
                            <label for="productCategory">Category</label>
                            <div id="productCategoryFeedback" class="invalid-feedback">Use letters, spaces, apostrophes,
                                hyphens, slashes, dots; min 2 chars.</div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" step="0.01" min="0.01" class="form-control" id="productPrice"
                                        placeholder="Price" required aria-describedby="productPriceFeedback">
                                    <label for="productPrice">Price *</label>
                                    <div id="productPriceFeedback" class="invalid-feedback">Enter a positive price (min
                                        0.01).</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" min="0" step="1" class="form-control" id="productQuantity"
                                        placeholder="Quantity" required aria-describedby="productQuantityFeedback">
                                    <label for="productQuantity">Quantity *</label>
                                    <div id="productQuantityFeedback" class="invalid-feedback">Enter a whole number 0 or
                                        greater.</div>
                                </div>
                            </div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="number" min="0" step="1" class="form-control" id="productReorder" value="10"
                                placeholder="Reorder Level" aria-describedby="productReorderFeedback">
                            <label for="productReorder">Reorder Level</label>
                            <div id="productReorderFeedback" class="invalid-feedback">Enter a whole number 0 or greater.
                            </div>
                        </div>
                        <div class="form-floating">
                            <select class="form-select" id="productSupplier" aria-label="Supplier Select"></select>
                            <label for="productSupplier">Supplier</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="supplierModal" tabindex="-1" aria-labelledby="supplierModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="supplierModalTitle">Add Supplier</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="supplierForm">
                        <input type="hidden" id="supplierId">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="supplierName" placeholder="Supplier Name"
                                required pattern="^[A-Za-z][A-Za-z\s'\-.]{1,}$" inputmode="text" maxlength="100"
                                autocomplete="off" aria-describedby="supplierNameFeedback">
                            <label for="supplierName">Supplier Name *</label>
                            <div id="supplierNameFeedback" class="invalid-feedback">Enter a valid name: letters, spaces,
                                apostrophes, hyphens, dots; min 2 chars.</div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="supplierContact" placeholder="Contact Person"
                                pattern="^[A-Za-z][A-Za-z\s'\-.]{1,}$" inputmode="text" maxlength="100"
                                aria-describedby="supplierContactFeedback">
                            <label for="supplierContact">Contact Person</label>
                            <div id="supplierContactFeedback" class="invalid-feedback">Enter a valid name (letters,
                                spaces, apostrophes, hyphens, dots).</div>
                        </div>
                        <div class="mb-3">
                            <label for="supplierPhone" class="form-label">Phone</label>
                            <div class="input-group">
                                <select class="form-select" id="supplierPhoneCode" style="max-width: 140px">
                                    <option value="+91" data-len="10"> +91</option>
                                    <option value="+1" data-len="10"> +1</option>
                                    <option value="+44" data-len="10"> +44</option>
                                    <option value="+61" data-len="9"> +61</option>
                                    <option value="+971" data-len="9"> +971</option>
                                    <option value="+81" data-len="10"> +81</option>
                                </select>
                                <input type="tel" class="form-control" id="supplierPhone" placeholder="Phone number"
                                    inputmode="numeric" aria-describedby="supplierPhoneFeedback" maxlength="15">
                                <div id="supplierPhoneFeedback" class="invalid-feedback">Enter a valid number for the
                                    selected country.</div>
                            </div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" id="supplierEmail" placeholder="Email"
                                maxlength="120" aria-describedby="supplierEmailFeedback">
                            <label for="supplierEmail">Email</label>
                            <div id="supplierEmailFeedback" class="invalid-feedback">Enter a valid email address.</div>
                        </div>
                        <div class="form-floating">
                            <textarea class="form-control" id="supplierAddress" placeholder="Address"
                                style="height: 100px" maxlength="200"
                                aria-describedby="supplierAddressFeedback"></textarea>
                            <label for="supplierAddress">Address</label>
                            <div id="supplierAddressFeedback" class="invalid-feedback">Max 200 characters.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSupplier()">Save Supplier</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerModalTitle">Add Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerForm">
                        <input type="hidden" id="customerId">
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="customerName" placeholder="Customer Name"
                                required pattern="^[A-Za-z][A-Za-z\s'\-.]{1,}$" inputmode="text" maxlength="100"
                                autocomplete="off" aria-describedby="customerNameFeedback">
                            <label for="customerName">Customer Name *</label>
                            <div id="customerNameFeedback" class="invalid-feedback">Enter a valid name: letters, spaces,
                                apostrophes, hyphens, dots; min 2 chars.</div>
                        </div>
                        <div class="mb-3">
                            <label for="customerPhone" class="form-label">Phone</label>
                            <div class="input-group">
                                <select class="form-select" id="customerPhoneCode" style="max-width: 140px">
                                    <option value="+91" data-len="10"> +91</option>
                                    <option value="+1" data-len="10"> +1</option>
                                    <option value="+44" data-len="10"> +44</option>
                                    <option value="+61" data-len="9"> +61</option>
                                    <option value="+971" data-len="9"> +971</option>
                                    <option value="+81" data-len="10"> +81</option>
                                </select>
                                <input type="tel" class="form-control" id="customerPhone" placeholder="Phone number"
                                    inputmode="numeric" aria-describedby="customerPhoneFeedback" maxlength="15">
                                <div id="customerPhoneFeedback" class="invalid-feedback">Enter a valid number for the
                                    selected country.</div>
                            </div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" id="customerEmail" placeholder="Email"
                                maxlength="120" aria-describedby="customerEmailFeedback">
                            <label for="customerEmail">Email</label>
                            <div id="customerEmailFeedback" class="invalid-feedback">Enter a valid email address.</div>
                        </div>
                        <div class="form-floating">
                            <textarea class="form-control" id="customerAddress" placeholder="Address"
                                style="height: 100px" maxlength="200"
                                aria-describedby="customerAddressFeedback"></textarea>
                            <label for="customerAddress">Address</label>
                            <div id="customerAddressFeedback" class="invalid-feedback">Max 200 characters.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCustomer()">Save Customer</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="saleModal" tabindex="-1" aria-labelledby="saleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Record Sale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="saleForm">
                        <div class="form-floating mb-3">
                            <select class="form-select" id="saleProduct" required aria-label="Product Select"
                                aria-describedby="saleProductFeedback"></select>
                            <label for="saleProduct">Product *</label>
                            <div id="saleProductFeedback" class="invalid-feedback">Please select a product.</div>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="saleCustomer" required aria-label="Customer Select"
                                aria-describedby="saleCustomerFeedback"></select>
                            <label for="saleCustomer">Customer *</label>
                            <div id="saleCustomerFeedback" class="invalid-feedback">Please select a customer.</div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="number" class="form-control" id="saleQuantity" placeholder="Quantity" required
                                min="1" step="1" aria-describedby="saleQuantityFeedback">
                            <label for="saleQuantity">Quantity *</label>
                            <div id="saleQuantityFeedback" class="invalid-feedback">Enter a whole number of at least 1.
                            </div>
                        </div>
                        <div class="alert alert-info d-flex align-items-center" role="alert">
                            <i class="bi bi-info-circle flex-shrink-0 me-2"></i>
                            <div>Total amount will be calculated automatically.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSale()">Record Sale</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="purchaseModal" tabindex="-1" aria-labelledby="purchaseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Record Purchase</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="purchaseForm">
                        <div class="form-floating mb-3">
                            <select class="form-select" id="purchaseProduct" required aria-label="Product Select"
                                aria-describedby="purchaseProductFeedback"></select>
                            <label for="purchaseProduct">Product *</label>
                            <div id="purchaseProductFeedback" class="invalid-feedback">Please select a product.</div>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="purchaseSupplier" required aria-label="Supplier Select"
                                aria-describedby="purchaseSupplierFeedback"></select>
                            <label for="purchaseSupplier">Supplier *</label>
                            <div id="purchaseSupplierFeedback" class="invalid-feedback">Please select a supplier.</div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="purchaseQuantity"
                                        placeholder="Quantity" required min="1" step="1"
                                        aria-describedby="purchaseQuantityFeedback">
                                    <label for="purchaseQuantity">Quantity *</label>
                                    <div id="purchaseQuantityFeedback" class="invalid-feedback">Enter a whole number of
                                        at least 1.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" step="0.01" min="0.01" class="form-control" id="purchaseCost"
                                        placeholder="Unit Cost" required aria-describedby="purchaseCostFeedback">
                                    <label for="purchaseCost">Unit Cost *</label>
                                    <div id="purchaseCostFeedback" class="invalid-feedback">Enter a positive cost (min
                                        0.01).</div>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info d-flex align-items-center" role="alert">
                            <i class="bi bi-info-circle flex-shrink-0 me-2"></i>
                            <div>Total cost will be calculated automatically.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePurchase()">Record Purchase</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE_URL = '';
        const API_URL = API_BASE_URL + '/api';

        // --- UX Helpers ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) {
                console.error("Toast container not found!");
                return;
            }

            const color = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : type === 'warning' ? 'bg-warning text-dark' : 'bg-primary';
            const el = document.createElement('div');
            // Ensure toast class is present for proper styling and JS initialization
            el.className = `toast align-items-center text-white ${color} border-0`;
            el.setAttribute('role', 'alert');
            el.setAttribute('aria-live', 'assertive');
            el.setAttribute('aria-atomic', 'true');
            el.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;

            container.appendChild(el);

            try {
                const toast = new bootstrap.Toast(el, { delay: 3500 }); // Slightly longer delay
                toast.show();
                el.addEventListener('hidden.bs.toast', () => el.remove(), { once: true }); // Use { once: true } for cleanup
            } catch (e) {
                console.error("Error showing toast:", e);
                el.remove(); // Clean up if bootstrap failed
            }
        }

        function getAuthToken() { try { return localStorage.getItem('authToken') || ''; } catch { return ''; } }
        function setAuth(token) { try { localStorage.setItem('authToken', token || ''); } catch { } }
        function clearAuth() { try { localStorage.removeItem('authToken'); localStorage.removeItem('authUser'); } catch { } }
        function getAuthUser() { try { return localStorage.getItem('authUser') || 'Admin'; } catch { return 'Admin'; } }

        async function apiFetch(url, options = {}, { useOverlay = false } = {}) {
            // No global overlay used anymore
            try {
                const token = getAuthToken();
                const authHeader = token ? { 'Authorization': `Bearer ${token}` } : {};
                const defaultHeaders = { 'Content-Type': 'application/json', 'Accept': 'application/json', ...authHeader, ...options.headers };
                const fetchOptions = { ...options, headers: defaultHeaders };
                // Ensure body is stringified only if it's a JS object and method is not GET/HEAD
                if (fetchOptions.body && typeof fetchOptions.body !== 'string' && !(['GET', 'HEAD'].includes(fetchOptions.method?.toUpperCase()))) {
                    fetchOptions.body = JSON.stringify(fetchOptions.body);
                } else if (['GET', 'HEAD'].includes(fetchOptions.method?.toUpperCase())) {
                    delete fetchOptions.body; // Body not allowed for GET/HEAD
                }

                const res = await fetch(url, fetchOptions);
                const isJson = (res.headers.get('content-type') || '').includes('application/json');

                // Attempt to parse JSON even on error for backend messages
                let body;
                try {
                    body = isJson ? await res.json() : await res.text();
                } catch (parseError) {
                    console.error("Error parsing response body:", parseError);
                    // If parsing fails after non-ok status, use status text
                    if (!res.ok) throw new Error(res.statusText || `Request failed with status ${res.status}`);
                    body = "Response parsing error"; // Fallback for ok response with bad body
                }


                if (!res.ok) {
                    if (res.status === 401) {
                        clearAuth();
                        try { window.location.href = '/'; } catch { }
                    }
                    let errorMsg = `Request failed (${res.status} ${res.statusText})`;
                    // Prioritize backend JSON error message
                    if (isJson && body && body.error) {
                        errorMsg = body.error;
                    } else if (!isJson && typeof body === 'string' && body.trim()) {
                        // Use text response if available and not empty
                        errorMsg = body.trim();
                    }
                    console.error("API Error Response Body:", body);
                    throw new Error(errorMsg);
                }
                return body;
            } catch (error) {
                console.error(`API Fetch Error (${url}):`, error);
                // Re-throw a more specific error if possible, otherwise the original
                throw new Error(error.message || `Network error or invalid response from ${url}`);
            }
        }

        // --- Chart Helper ---
        let reportChart = null; // Initialize as null
        function renderChart(ctx, type, data, options) {
            // Ensure Chart.js is loaded
            if (typeof Chart === 'undefined') {
                // Try loading it again if needed, or just warn
                console.warn("Chart.js not loaded. Cannot render chart.");
                // Optionally append script if missing
                if (!document.querySelector('script[src*="chart.umd.min.js"]')) {
                    const chartScript = document.createElement('script');
                    chartScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js';
                    chartScript.onload = () => console.log("Chart.js loaded dynamically.");
                    chartScript.onerror = () => console.error("Failed to load Chart.js dynamically");
                    document.body.appendChild(chartScript);
                }
                return;
            }

            if (reportChart) {
                try {
                    reportChart.destroy();
                } catch (e) { console.error("Error destroying previous chart:", e); }
                reportChart = null; // Reset reference
            }

            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = isDark ? '#e5e7eb' : '#495057';

            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: textColor } },
                    tooltip: {
                        bodyColor: textColor, titleColor: textColor,
                        backgroundColor: isDark ? 'rgba(31, 41, 55, 0.9)' : 'rgba(255, 255, 255, 0.9)',
                        borderColor: gridColor, borderWidth: 1
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                    x: { grid: { color: gridColor }, ticks: { color: textColor } }
                }
            };

            try {
                reportChart = new Chart(ctx, { type, data, options: { ...defaultOptions, ...options } });
            } catch (e) {
                console.error("Error creating chart:", e);
                showToast("Could not display chart.", "error");
            }
        }

        // --- Formatters ---
        const INR = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 });
        function formatCurrency(value) {
            const num = Number(value || 0);
            return Number.isFinite(num) ? INR.format(num) : '0';
        }

        // --- Theme Toggle ---
        (function initTheme() {
            const btn = document.getElementById('themeToggle');
            const nav = document.querySelector('.navbar');
            if (!btn || !nav) return;
            const icon = btn.querySelector('i');

            const setTheme = (theme) => {
                const isDark = theme === 'dark';
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);

                icon.classList.toggle('bi-moon-fill', !isDark);
                icon.classList.toggle('bi-sun-fill', isDark);
                btn.classList.toggle('btn-outline-secondary', !isDark);
                btn.classList.toggle('btn-outline-light', isDark);
                nav.classList.toggle('navbar-dark', isDark);

                // Re-render chart only if reports section is active
                if (reportChart && document.getElementById('reports-section')?.classList.contains('active')) {
                    const activeReportBtn = document.querySelector('#reports-section .btn.active');
                    if (activeReportBtn) {
                        const onclickAttr = activeReportBtn.getAttribute('onclick');
                        const match = onclickAttr?.match(/loadReport\('([^']+)'\)/);
                        if (match && match[1]) {
                            // Introduce a tiny delay to allow CSS vars to update fully
                            setTimeout(() => loadReport(match[1]), 50);
                        }
                    }
                }
            };

            const saved = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            setTheme(saved); // Apply theme immediately on load

            btn.addEventListener('click', () => {
                const currentTheme = document.body.getAttribute('data-theme');
                setTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });
        })();

        // --- Navigation ---
        function navigateToPage(pageName, reportType = null) {
            console.log(`Navigating to: ${pageName}${reportType ? ` (${reportType})` : ''}`); // Debug log
            const targetLink = document.querySelector(`.sidebar .nav-link[data-page='${pageName}']`);
            if (targetLink) {
                // Check if it's already active to prevent unnecessary re-clicks/reloads
                if (!targetLink.classList.contains('active')) {
                    targetLink.click();
                } else if (pageName === 'reports' && reportType) {
                    // If already on reports, just load the specific report
                    const reportButton = document.querySelector(`#reports-section .btn[onclick="loadReport('${reportType}')"]`);
                    if (reportButton && !reportButton.classList.contains('active')) reportButton.click();
                }

                // Special handling for reports link from dashboard card
                if (pageName === 'reports' && reportType && targetLink.classList.contains('active')) {
                    setTimeout(() => {
                        const reportButton = document.querySelector(`#reports-section .btn[onclick="loadReport('${reportType}')"]`);
                        if (reportButton) reportButton.click();
                    }, 50);
                }
            } else {
                console.error(`Navigation target link not found for page: ${pageName}`);
                showToast(`Error: Could not find navigation link for ${pageName}.`, "error");
            }
        }

        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                // Prevent re-loading if clicking the already active link
                if (this.classList.contains('active')) {
                    console.log(`Link ${this.dataset.page} already active.`);
                    return;
                }

                console.log(`Sidebar link clicked: ${this.dataset.page}`); // Debug log

                document.querySelector('.sidebar .nav-link.active')?.classList.remove('active');
                this.classList.add('active');

                const page = this.dataset.page;

                document.querySelectorAll('.page-section').forEach(section => {
                    section.classList.remove('active');
                });
                const targetSection = document.getElementById(`${page}-section`);
                if (targetSection) {
                    targetSection.classList.add('active');
                    console.log(`Loading data for page: ${page}`); // Debug log
                    loadPageData(page); // Load data AFTER section is made active
                } else {
                    console.error(`Page section not found for id: ${page}-section`);
                    showToast(`Error: UI section for ${page} not found.`, "error");
                }
            });
        });

        function loadPageData(page) {
            console.log(`Executing loadPageData for: ${page}`); // Debug log
            // Clear previous report chart if navigating away from reports
            if (page !== 'reports' && reportChart) {
                reportChart.destroy();
                reportChart = null;
            }

            // Centralized error handling wrapper for load functions
            const loadFunction = async (func) => {
                try {
                    await func();
                } catch (error) {
                    console.error(`Error loading data for ${page}:`, error);
                    // Display error within the specific section if possible
                    const sectionContent = document.querySelector(`#${page}-section .table-container tbody, #${page}-section #reportContent, #${page}-section #lowStockAlerts`); // Common containers
                    if (sectionContent) {
                        // Adapt error message based on container type
                        if (sectionContent.tagName === 'TBODY') {
                            const colspan = sectionContent.closest('table')?.querySelector('thead tr th')?.length || 1;
                            sectionContent.innerHTML = `<tr><td colspan="${colspan}" class="text-danger text-center py-4">Failed to load data: ${error.message || 'Unknown error'}</td></tr>`;
                        } else {
                            sectionContent.innerHTML = `<p class="text-danger text-center py-4">Failed to load data: ${error.message || 'Unknown error'}</p>`;
                        }
                    } else {
                        // Fallback toast if no specific container found
                        showToast(`Failed to load ${page} data: ${error.message}`, "error");
                    }
                }
            };


            switch (page) {
                case 'dashboard': loadFunction(loadDashboard); break;
                case 'products': loadFunction(loadProducts); break;
                case 'suppliers': loadFunction(loadSuppliers); break;
                case 'customers': loadFunction(loadCustomers); break;
                case 'sales': loadFunction(loadSales); break;
                case 'purchases': loadFunction(loadPurchases); break;
                case 'reports':
                    // Reset reports section, don't trigger loadFunction here, report buttons do it
                    document.getElementById('reportTitle').textContent = 'Select a report to view';
                    document.getElementById('reportContent').innerHTML = '<p class="text-muted">Report data and chart will appear here.</p>';
                    document.querySelectorAll('#reports-section .btn-outline-primary').forEach(b => b.classList.remove('active'));
                    if (reportChart) { reportChart.destroy(); reportChart = null; }
                    break;
                default: console.warn(`No data loading logic defined for page: ${page}`);
            }
        }

        // --- Data Loading & Rendering Functions (with improved error handling) ---

        // Dashboard
        async function loadDashboard() {
            const totalProductsEl = document.getElementById('totalProducts');
            const totalSalesEl = document.getElementById('totalSales');
            const lowStockCountEl = document.getElementById('lowStockCount');
            const totalCustomersEl = document.getElementById('totalCustomers');

            totalProductsEl.innerHTML = '<span class="skeleton w-50"></span>';
            totalSalesEl.innerHTML = '<span class="skeleton w-75"></span>';
            lowStockCountEl.innerHTML = '<span class="skeleton w-25"></span>';
            totalCustomersEl.innerHTML = '<span class="skeleton w-50"></span>';

            // Fetch main stats first - Let error propagate up if this fails
            const data = await apiFetch(`${API_URL}/dashboard`);

            totalProductsEl.textContent = data.TotalProducts;
            totalSalesEl.textContent = `${data.TotalSales.toLocaleString()}`;
            lowStockCountEl.textContent = data.LowStockCount;
            totalCustomersEl.textContent = data.TotalCustomers;

            // Load alerts separately, handle its potential failure independently
            try {
                // Use await here to ensure it tries to load before function returns
                await loadLowStockAlerts();
            } catch (alertError) {
                console.error("Non-critical error loading low stock alerts:", alertError);
                const alertsDiv = document.getElementById('lowStockAlerts');
                if (alertsDiv) alertsDiv.innerHTML = '<p class="text-warning mb-0">Could not load low stock alerts.</p>';
            }
        }

        async function loadLowStockAlerts() {
            const alertsDiv = document.getElementById('lowStockAlerts');
            if (!alertsDiv) return; // Add guard clause
            alertsDiv.innerHTML = `<div class="skeleton mb-2" style="height: 18px;"></div><div class="skeleton w-75 mb-2" style="height: 18px;"></div>`;

            // Fetch low stock data - propagate error if it fails
            const products = await apiFetch(`${API_URL}/reports/low-stock`);

            if (products.length === 0) {
                alertsDiv.innerHTML = '<p class="text-muted mb-0">No low stock items found.</p>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm table-hover align-middle mb-0"><thead><tr><th>Product</th><th>Category</th><th>Stock</th><th>Reorder</th><th>Supplier</th></tr></thead><tbody>';
            products.slice(0, 5).forEach(p => {
                html += `<tr class="table-warning">
                    <td>${p.ProductName}</td>
                    <td>${p.Category || 'N/A'}</td>
                    <td><span class="badge bg-danger">${p.Quantity}</span></td>
                    <td>${p.ReorderLevel}</td>
                    <td>${p.SupplierName || 'N/A'}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            if (products.length > 5) {
                html += `<div class="text-center mt-2"><button class="btn btn-sm btn-outline-warning" onclick="navigateToPage('reports', 'LowStock')">View All (${products.length})</button></div>`;
            }
            alertsDiv.innerHTML = html;
        }


        // Products
        let productsData = [];
        let productsFiltered = [];
        let productsPage = 1;
        const productsTableBody = document.getElementById('productsTable');

        function renderProductSkeleton() {
            if (!productsTableBody) return;
            let skeletonHTML = '';
            const rowsToShow = parseInt(document.getElementById('productPageSize')?.value) || 5;
            for (let i = 0; i < rowsToShow; i++) {
                skeletonHTML += `<tr><td colspan="8"><div class="skeleton my-2" style="height: 20px;"></div></td></tr>`;
            }
            productsTableBody.innerHTML = skeletonHTML;
            document.getElementById('productPagination').innerHTML = '';
            document.getElementById('productCount').textContent = 'Loading...';
        }

        async function loadProducts() {
            renderProductSkeleton();
            productsData = await apiFetch(`${API_URL}/products`); // Propagates error
            // Sort by ProductID ascending
            productsData = Array.isArray(productsData) ? productsData.slice().sort((a, b) => (a?.ProductID || 0) - (b?.ProductID || 0)) : [];
            productsFiltered = productsData;
            productsPage = 1;
            wireProductControls();
            renderProducts();
        }

        let productControlsWired = false;
        function wireProductControls() {
            if (productControlsWired) return;
            const search = document.getElementById('productSearch');
            const pageSizeSel = document.getElementById('productPageSize');
            if (search) search.addEventListener('input', filterProducts);
            if (pageSizeSel) {
                // Load preferred page size from settings
                try { const s = JSON.parse(localStorage.getItem('appSettings') || '{}'); if (s.pageSize) pageSizeSel.value = String(s.pageSize); } catch { }
                pageSizeSel.addEventListener('change', () => { productsPage = 1; renderProducts(); });
            }
            productControlsWired = true;
        }

        function filterProducts() {
            const q = document.getElementById('productSearch')?.value?.toLowerCase() || '';
            productsFiltered = productsData.filter(p =>
                (p.ProductName || '').toLowerCase().includes(q) ||
                (p.Category || '').toLowerCase().includes(q)
            );
            productsPage = 1;
            renderProducts();
        }

        function renderProducts() {
            if (!productsTableBody) return;

            const pageSize = parseInt(document.getElementById('productPageSize')?.value) || 10;
            const total = productsFiltered.length;
            const countEl = document.getElementById('productCount');
            const paginationEl = document.getElementById('productPagination');

            if (total === 0) {
                productsTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No products found matching your criteria.</td></tr>';
                if (paginationEl) paginationEl.innerHTML = '';
                if (countEl) countEl.textContent = '0 items';
                return;
            }

            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (productsPage > totalPages) productsPage = totalPages;
            if (productsPage < 1) productsPage = 1;

            const start = (productsPage - 1) * pageSize;
            const end = start + pageSize;
            const rows = productsFiltered.slice(start, end);

            if (countEl) countEl.textContent = `Showing ${start + 1}-${start + rows.length} of ${total} items`;

            let tableHTML = '';
            rows.forEach(p => {
                const isLow = p.Quantity <= p.ReorderLevel;
                const isOut = p.Quantity <= 0;
                const statusBadge = isOut ? `<span class="badge bg-danger-subtle text-danger-emphasis">Out of Stock</span>` : isLow ? `<span class="badge bg-warning-subtle text-warning-emphasis">Low Stock</span>` : '<span class="badge bg-success-subtle text-success-emphasis">In Stock</span>';

                tableHTML += `<tr>
                    <td>${p.ProductID}</td>
                    <td>${p.ProductName || 'N/A'}</td>
                    <td>${p.Category || 'N/A'}</td>
                    <td>${parseFloat(p.Price || 0).toLocaleString()}</td>
                    <td>${p.Quantity}</td>
                    <td>${p.SupplierName || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${p.ProductID})" title="Edit Product"><i class="bi bi-pencil-fill"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${p.ProductID})" title="Delete Product"><i class="bi bi-trash-fill"></i></button>
                    </td>
                </tr>`;
            });
            productsTableBody.innerHTML = tableHTML;

            renderPagination(paginationEl, productsPage, totalPages, (page) => {
                productsPage = page;
                renderProducts();
            });
        }

        function renderPagination(container, currentPage, totalPages, onPageClick) {
            if (!container || totalPages <= 1) {
                if (container) container.innerHTML = ''; return;
            }
            container.innerHTML = '';
            const createPageItem = (label, page, isDisabled = false, isActive = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
                const a = document.createElement('a'); a.className = 'page-link'; a.href = '#'; a.innerHTML = label;
                if (!isDisabled) a.onclick = (e) => { e.preventDefault(); onPageClick(page); };
                li.appendChild(a); return li;
            };
            container.appendChild(createPageItem('&laquo;', 1, currentPage === 1));
            container.appendChild(createPageItem('&lsaquo;', currentPage - 1, currentPage === 1));
            const windowSize = 2; let startPage = Math.max(1, currentPage - windowSize); let endPage = Math.min(totalPages, currentPage + windowSize);
            if (startPage > 1) { container.appendChild(createPageItem('1', 1)); if (startPage > 2) container.appendChild(createPageItem('...', currentPage - windowSize - 1, true)); }
            for (let p = startPage; p <= endPage; p++) container.appendChild(createPageItem(String(p), p, false, p === currentPage));
            if (endPage < totalPages) { if (endPage < totalPages - 1) container.appendChild(createPageItem('...', currentPage + windowSize + 1, true)); container.appendChild(createPageItem(String(totalPages), totalPages)); }
            container.appendChild(createPageItem('&rsaquo;', currentPage + 1, currentPage === totalPages));
            container.appendChild(createPageItem('&raquo;', totalPages, currentPage === totalPages));
        }

        // Product Modal Logic
        function openProductModal(product = null) {
            const modalEl = document.getElementById('productModal');
            const modalTitle = document.getElementById('productModalTitle');
            const form = document.getElementById('productForm');
            if (!modalEl || !modalTitle || !form) return;
            form.reset(); document.getElementById('productId').value = '';
            if (product) {
                modalTitle.textContent = 'Edit Product';
                document.getElementById('productId').value = product.ProductID;
                document.getElementById('productName').value = product.ProductName;
                document.getElementById('productDescription').value = product.Description || '';
                document.getElementById('productCategory').value = product.Category || '';
                document.getElementById('productPrice').value = product.Price;
                document.getElementById('productQuantity').value = product.Quantity;
                document.getElementById('productReorder').value = product.ReorderLevel;
                loadSupplierDropdown('productSupplier').then(() => { document.getElementById('productSupplier').value = product.SupplierID || ''; });
            } else {
                modalTitle.textContent = 'Add Product';
                loadSupplierDropdown('productSupplier');
            }
            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl); modalInstance.show();
        }
        async function editProduct(id) {
            try {
                showToast("Loading product details...", "info");
                const product = await apiFetch(`${API_URL}/products/${id}`);
                openProductModal(product);
            } catch (error) { showToast(`Failed to load product details: ${error.message}`, 'error'); }
        }
        async function saveProduct() {
            const form = document.getElementById('productForm');
            if (!form.checkValidity()) { form.reportValidity(); showToast('Please fill all required fields correctly.', 'warning'); return; }
            const id = document.getElementById('productId').value;
            const data = {
                ProductName: document.getElementById('productName').value.trim(), Description: document.getElementById('productDescription').value.trim(), Category: document.getElementById('productCategory').value.trim(),
                Price: parseFloat(document.getElementById('productPrice').value), Quantity: parseInt(document.getElementById('productQuantity').value), ReorderLevel: parseInt(document.getElementById('productReorder').value), SupplierID: document.getElementById('productSupplier').value || null
            };
            if (!data.ProductName || data.Price < 0 || data.Quantity < 0 || data.ReorderLevel < 0) { showToast('Invalid data...', 'warning'); return; }
            const url = id ? `${API_URL}/products/${id}` : `${API_URL}/products`; const method = id ? 'PUT' : 'POST';
            const saveButton = document.querySelector('#productModal .btn-primary'); const originalButtonText = saveButton.innerHTML; saveButton.disabled = true; saveButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving...`;
            try {
                await apiFetch(url, { method, body: data }); // Pass object directly
                bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                showToast(`Product ${id ? 'updated' : 'added'}!`, 'success');
                await loadProducts(); // Use await
                if (document.getElementById('dashboard-section').classList.contains('active')) await loadDashboard(); // Use await
            } catch (error) { showToast(`Error saving product: ${error.message}`, 'error'); }
            finally { saveButton.disabled = false; saveButton.innerHTML = originalButtonText; }
        }
        async function deleteProduct(id) {
            if (!confirm(`Delete product ID ${id}?`)) return;
            try {
                showToast("Deleting product...", "info");
                await apiFetch(`${API_URL}/products/${id}`, { method: 'DELETE' });
                showToast('Product deleted!', 'success');
                await loadProducts(); // Use await
                if (document.getElementById('dashboard-section').classList.contains('active')) await loadDashboard(); // Use await
            } catch (error) { showToast(`Error deleting product: ${error.message}`, 'error'); }
        }

        // --- Suppliers (CRUD + Search) ---
        let suppliersData = [];
        let suppliersFiltered = [];
        const suppliersTableBody = document.getElementById('suppliersTable');
        let supplierControlsWired = false;
        function wireSupplierControls() {
            if (supplierControlsWired) return;
            const search = document.getElementById('supplierSearch');
            if (search) search.addEventListener('input', filterSuppliers);
            supplierControlsWired = true;
        }
        function renderSupplierSkeleton() { /* ... */
            if (!suppliersTableBody) return;
            let s = ''; for (let i = 0; i < 3; i++) s += `<tr><td colspan="6"><div class="skeleton my-2" style="height:20px"></div></td></tr>`;
            suppliersTableBody.innerHTML = s;
        }
        async function loadSuppliers() {
            renderSupplierSkeleton();
            suppliersData = await apiFetch(`${API_URL}/suppliers`); // Propagates error
            suppliersData = Array.isArray(suppliersData) ? suppliersData.slice().sort((a, b) => (a?.SupplierID || 0) - (b?.SupplierID || 0)) : [];
            suppliersFiltered = suppliersData;
            wireSupplierControls();
            renderSuppliers();
        }
        function filterSuppliers() {
            const q = document.getElementById('supplierSearch')?.value?.toLowerCase() || '';
            suppliersFiltered = suppliersData.filter(s =>
                String(s.SupplierID || '').includes(q) ||
                (s.SupplierName || '').toLowerCase().includes(q) ||
                (s.ContactPerson || '').toLowerCase().includes(q) ||
                (s.Phone || '').toLowerCase().includes(q) ||
                (s.Email || '').toLowerCase().includes(q)
            );
            renderSuppliers();
        }
        function renderSuppliers() {
            if (!suppliersTableBody) return;
            if (suppliersFiltered.length === 0) { suppliersTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No suppliers found.</td></tr>'; return; }
            let t = '';
            suppliersFiltered.forEach(s => t += `<tr><td>${s.SupplierID}</td><td>${s.SupplierName || 'N/A'}</td><td>${s.ContactPerson || 'N/A'}</td><td>${s.Phone || 'N/A'}</td><td>${s.Email || 'N/A'}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary" onclick="editSupplier(${s.SupplierID})" title="Edit"><i class="bi bi-pencil-fill"></i></button> <button class="btn btn-sm btn-outline-danger" onclick="deleteSupplier(${s.SupplierID})" title="Delete"><i class="bi bi-trash-fill"></i></button></td></tr>`);
            suppliersTableBody.innerHTML = t;
        }
        function openSupplierModal(supplier = null) { /* ... */
            const m = document.getElementById('supplierModal'), t = document.getElementById('supplierModalTitle'), f = document.getElementById('supplierForm'); if (!m || !t || !f) return; f.reset(); document.getElementById('supplierId').value = '';
            const setPhone = (full, codeId, inputId) => {
                const codeEl = document.getElementById(codeId), inputEl = document.getElementById(inputId); if (!codeEl || !inputEl) return;
                const value = String(full || '');
                const options = [...codeEl.options].map(o => o.value).sort((a, b) => b.length - a.length);
                let chosen = codeEl.options[0].value; let rest = value;
                if (value.startsWith('+')) { const match = options.find(v => value.startsWith(v)); if (match) { chosen = match; rest = value.slice(match.length); } }
                codeEl.value = chosen;
                inputEl.value = (rest || '').replace(/\D/g, '');
            };
            if (supplier) {
                t.textContent = 'Edit';
                document.getElementById('supplierId').value = supplier.SupplierID;
                document.getElementById('supplierName').value = supplier.SupplierName;
                document.getElementById('supplierContact').value = supplier.ContactPerson || '';
                setPhone(supplier.Phone, 'supplierPhoneCode', 'supplierPhone');
                document.getElementById('supplierEmail').value = supplier.Email || '';
                document.getElementById('supplierAddress').value = supplier.Address || '';
            } else { t.textContent = 'Add'; }
            bootstrap.Modal.getOrCreateInstance(m).show();
        }
        async function editSupplier(id) { /* ... */ try { showToast("Loading...", "info"); const s = await apiFetch(`${API_URL}/suppliers/${id}`); openSupplierModal(s); } catch (e) { showToast(`Load failed: ${e.message}`, 'error'); } }
        async function saveSupplier() { /* ... */
            const f = document.getElementById('supplierForm'); if (!f.checkValidity()) { f.reportValidity(); showToast('Name required.', 'warning'); return; } const id = document.getElementById('supplierId').value; const phone = `${document.getElementById('supplierPhoneCode').value}${(document.getElementById('supplierPhone').value || '').replace(/\D/g, '')}`; const d = { SupplierName: document.getElementById('supplierName').value.trim(), ContactPerson: document.getElementById('supplierContact').value.trim(), Phone: phone, Email: document.getElementById('supplierEmail').value.trim(), Address: document.getElementById('supplierAddress').value.trim() }; const u = id ? `${API_URL}/suppliers/${id}` : `${API_URL}/suppliers`; const m = id ? 'PUT' : 'POST'; const b = document.querySelector('#supplierModal .btn-primary'); const o = b.innerHTML; b.disabled = true; b.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving...`; try { await apiFetch(u, { method: m, body: d }); bootstrap.Modal.getInstance(document.getElementById('supplierModal')).hide(); showToast(`Supplier ${id ? 'updated' : 'added'}!`, 'success'); await loadSuppliers(); } catch (e) { showToast(`Save failed: ${e.message}`, 'error'); } finally { b.disabled = false; b.innerHTML = o; }
        }
        async function deleteSupplier(id) { /* ... */ if (!confirm(`Delete supplier ${id}?`)) return; try { showToast("Deleting...", "info"); await apiFetch(`${API_URL}/suppliers/${id}`, { method: 'DELETE' }); showToast('Deleted!', 'success'); await loadSuppliers(); if (document.getElementById('products-section').classList.contains('active')) await loadProducts(); } catch (e) { showToast(`Delete failed: ${e.message}`, 'error'); } }

        // --- Customers (CRUD + Search) ---
        let customersData = [];
        let customersFiltered = [];
        const customersTableBody = document.getElementById('customersTable');
        let customerControlsWired = false;
        function wireCustomerControls() { if (customerControlsWired) return; const s = document.getElementById('customerSearch'); if (s) s.addEventListener('input', filterCustomers); customerControlsWired = true; }
        function renderCustomerSkeleton() { /* ... */ if (!customersTableBody) return; let s = ''; for (let i = 0; i < 3; i++)s += `<tr><td colspan="6"><div class="skeleton my-2" style="height:20px"></div></td></tr>`; customersTableBody.innerHTML = s; }
        async function loadCustomers() { /* ... */
            renderCustomerSkeleton();
            customersData = await apiFetch(`${API_URL}/customers`); // Propagates error
            customersData = Array.isArray(customersData) ? customersData.slice().sort((a, b) => (a?.CustomerID || 0) - (b?.CustomerID || 0)) : [];
            customersFiltered = customersData;
            wireCustomerControls();
            renderCustomers();
        }
        function filterCustomers() {
            const q = document.getElementById('customerSearch')?.value?.toLowerCase() || '';
            customersFiltered = customersData.filter(c =>
                String(c.CustomerID || '').includes(q) ||
                (c.CustomerName || '').toLowerCase().includes(q) ||
                (c.Phone || '').toLowerCase().includes(q) ||
                (c.Email || '').toLowerCase().includes(q) ||
                (c.Address || '').toLowerCase().includes(q)
            );
            renderCustomers();
        }
        function renderCustomers() {
            if (!customersTableBody) return;
            if (customersFiltered.length === 0) { customersTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No customers found.</td></tr>'; return; }
            let t = ''; customersFiltered.forEach(c => t += `<tr><td>${c.CustomerID}</td><td>${c.CustomerName || 'N/A'}</td><td>${c.Phone || 'N/A'}</td><td>${c.Email || 'N/A'}</td><td>${c.Address || 'N/A'}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary" onclick="editCustomer(${c.CustomerID})" title="Edit"><i class="bi bi-pencil-fill"></i></button> <button class="btn btn-sm btn-outline-danger" onclick="deleteCustomer(${c.CustomerID})" title="Delete"><i class="bi bi-trash-fill"></i></button></td></tr>`);
            customersTableBody.innerHTML = t;
        }
        function openCustomerModal(customer = null) { /* ... */ const m = document.getElementById('customerModal'), t = document.getElementById('customerModalTitle'), f = document.getElementById('customerForm'); if (!m || !t || !f) return; f.reset(); document.getElementById('customerId').value = ''; const setPhone = (full, codeId, inputId) => { const codeEl = document.getElementById(codeId), inputEl = document.getElementById(inputId); if (!codeEl || !inputEl) return; const value = String(full || ''); const options = [...codeEl.options].map(o => o.value).sort((a, b) => b.length - a.length); let chosen = codeEl.options[0].value, rest = value; if (value.startsWith('+')) { const match = options.find(v => value.startsWith(v)); if (match) { chosen = match; rest = value.slice(match.length); } } codeEl.value = chosen; inputEl.value = (rest || '').replace(/\D/g, ''); }; if (customer) { t.textContent = 'Edit'; document.getElementById('customerId').value = customer.CustomerID; document.getElementById('customerName').value = customer.CustomerName; setPhone(customer.Phone, 'customerPhoneCode', 'customerPhone'); document.getElementById('customerEmail').value = customer.Email || ''; document.getElementById('customerAddress').value = customer.Address || ''; } else { t.textContent = 'Add'; } bootstrap.Modal.getOrCreateInstance(m).show(); }
        async function editCustomer(id) { /* ... */ try { showToast("Loading...", "info"); const c = await apiFetch(`${API_URL}/customers/${id}`); openCustomerModal(c); } catch (e) { showToast(`Load failed: ${e.message}`, 'error'); } }
        async function saveCustomer() { /* ... */
            const f = document.getElementById('customerForm'); if (!f.checkValidity()) { f.reportValidity(); showToast('Name required.', 'warning'); return; } const id = document.getElementById('customerId').value; const phone = `${document.getElementById('customerPhoneCode').value}${(document.getElementById('customerPhone').value || '').replace(/\D/g, '')}`; const d = { CustomerName: document.getElementById('customerName').value.trim(), Phone: phone, Email: document.getElementById('customerEmail').value.trim(), Address: document.getElementById('customerAddress').value.trim() }; const u = id ? `${API_URL}/customers/${id}` : `${API_URL}/customers`; const m = id ? 'PUT' : 'POST'; const b = document.querySelector('#customerModal .btn-primary'); const o = b.innerHTML; b.disabled = true; b.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving...`; try { await apiFetch(u, { method: m, body: d }); bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide(); showToast(`Customer ${id ? 'updated' : 'added'}!`, 'success'); await loadCustomers(); if (document.getElementById('dashboard-section').classList.contains('active')) await loadDashboard(); } catch (e) { showToast(`Save failed: ${e.message}`, 'error'); } finally { b.disabled = false; b.innerHTML = o; }
        }
        async function deleteCustomer(id) { /* ... */ if (!confirm(`Delete customer ${id}?`)) return; try { showToast("Deleting...", "info"); await apiFetch(`${API_URL}/customers/${id}`, { method: 'DELETE' }); showToast('Deleted!', 'success'); await loadCustomers(); if (document.getElementById('dashboard-section').classList.contains('active')) await loadDashboard(); } catch (e) { showToast(`Delete failed: ${e.message}`, 'error'); } }

        // --- Sales (Read, Create + Search) ---
        let salesData = [];
        let salesFiltered = [];
        const salesTableBody = document.getElementById('salesTable');
        let salesControlsWired = false;
        function wireSalesControls() { if (salesControlsWired) return; const s = document.getElementById('salesSearch'); if (s) s.addEventListener('input', filterSales); salesControlsWired = true; }
        function renderSalesSkeleton() { /* ... */ if (!salesTableBody) return; let s = ''; for (let i = 0; i < 3; i++)s += `<tr><td colspan="6"><div class="skeleton my-2" style="height:20px"></div></td></tr>`; salesTableBody.innerHTML = s; }
        async function loadSales() { /* ... */
            renderSalesSkeleton();
            salesData = await apiFetch(`${API_URL}/sales`); // Propagates error
            salesData = Array.isArray(salesData) ? salesData.slice().sort((a, b) => (a?.SaleID || 0) - (b?.SaleID || 0)) : [];
            salesFiltered = salesData;
            wireSalesControls();
            renderSales();
        }
        function filterSales() {
            const q = document.getElementById('salesSearch')?.value?.toLowerCase() || '';
            salesFiltered = salesData.filter(s =>
                String(s.SaleID || '').includes(q) ||
                (s.ProductName || '').toLowerCase().includes(q) ||
                (s.CustomerName || '').toLowerCase().includes(q)
            );
            renderSales();
        }
        function renderSales() {
            if (!salesTableBody) return;
            if (salesFiltered.length === 0) { salesTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No sales recorded.</td></tr>'; return; }
            let t = ''; salesFiltered.forEach(s => { let d = 'Invalid'; try { d = new Date(s.SaleDate).toLocaleString(); } catch (e) { } t += `<tr><td>${s.SaleID}</td><td>${s.ProductName || 'N/A'}</td><td>${s.CustomerName || 'N/A'}</td><td>${s.QuantitySold}</td><td>${formatCurrency(s.TotalAmount)}</td><td>${d}</td></tr>`; }); salesTableBody.innerHTML = t;
        }
        async function openSaleModal() { /* ... */ const f = document.getElementById('saleForm'); if (!f) return; f.reset(); const pS = document.getElementById('saleProduct'), cS = document.getElementById('saleCustomer'); pS.innerHTML = '<option value="">Loading...</option>'; cS.innerHTML = '<option value="">Loading...</option>'; const m = document.getElementById('saleModal'); bootstrap.Modal.getOrCreateInstance(m).show(); try { await Promise.all([loadProductDropdown('saleProduct', true), loadCustomerDropdown('saleCustomer')]); } catch (e) { showToast("Error loading form data.", "error"); pS.innerHTML = '<option value="">Error</option>'; cS.innerHTML = '<option value="">Error</option>'; } }
        async function loadProductDropdown(id, onlyInStock = false) { /* ... */
            const s = document.getElementById(id); if (!s) return; s.innerHTML = '<option value="">Loading...</option>'; try { const p = await apiFetch(`${API_URL}/products`); let f = onlyInStock ? p.filter(i => i.Quantity > 0) : p; s.innerHTML = '<option value="">Select Product</option>'; if (f.length === 0) s.innerHTML = `<option value="" disabled>No products ${onlyInStock ? 'in stock' : 'available'}</option>`; else f.forEach(i => s.innerHTML += `<option value="${i.ProductID}">${i.ProductName} (Stock: ${i.Quantity})</option>`); } catch (e) { console.error(`Err loading PDD ${id}:`, e); s.innerHTML = '<option value="">Error</option>'; throw e; }
        }
        async function loadCustomerDropdown(id) { /* ... */
            const s = document.getElementById(id); if (!s) return; s.innerHTML = '<option value="">Loading...</option>'; try { const c = await apiFetch(`${API_URL}/customers`); s.innerHTML = '<option value="">Select Customer</option>'; if (c.length === 0) s.innerHTML = '<option value="" disabled>No customers</option>'; else c.forEach(i => s.innerHTML += `<option value="${i.CustomerID}">${i.CustomerName}</option>`); } catch (e) { console.error(`Err loading CDD ${id}:`, e); s.innerHTML = '<option value="">Error</option>'; throw e; }
        }
        async function loadSupplierDropdown(id) { /* ... */
            const s = document.getElementById(id); if (!s) return; s.innerHTML = '<option value="">Loading...</option>';
            try {
                const sup = await apiFetch(`${API_URL}/suppliers`);
                s.innerHTML = '<option value="">Select Supplier</option>';
                if (sup.length === 0) s.innerHTML = '<option value="" disabled>No suppliers</option>';
                else sup.forEach(i => s.innerHTML += `<option value="${i.SupplierID}">${i.SupplierName}</option>`);
            } catch (e) {
                console.error(`Err loading SDD ${id}:`, e);
                s.innerHTML = '<option value="">Error</option>';
                throw e;
            }
        }
        async function saveSale() { /* ... */
            const f = document.getElementById('saleForm'); const pV = document.getElementById('saleProduct').value, cV = document.getElementById('saleCustomer').value, qV = parseInt(document.getElementById('saleQuantity').value); if (!f.checkValidity() || !pV || !cV || qV <= 0) { f.reportValidity(); showToast('Select product, customer, valid qty > 0.', 'warning'); return; } const d = { ProductID: parseInt(pV), CustomerID: parseInt(cV), QuantitySold: qV }; const b = document.querySelector('#saleModal .btn-primary'); const o = b.innerHTML; b.disabled = true; b.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving...`; try { await apiFetch(`${API_URL}/sales`, { method: 'POST', body: d }); bootstrap.Modal.getInstance(document.getElementById('saleModal')).hide(); showToast('Sale recorded!', 'success'); await loadSales(); if (document.getElementById('dashboard-section').classList.contains('active')) await loadDashboard(); if (document.getElementById('products-section').classList.contains('active')) await loadProducts(); } catch (e) { showToast(`Save failed: ${e.message}`, 'error'); } finally { b.disabled = false; b.innerHTML = o; }
        }

        // --- Purchases (Read, Create + Search) ---
        let purchasesData = [];
        let purchasesFiltered = [];
        const purchasesTableBody = document.getElementById('purchasesTable');
        let purchasesControlsWired = false;
        function wirePurchasesControls() { if (purchasesControlsWired) return; const s = document.getElementById('purchasesSearch'); if (s) s.addEventListener('input', filterPurchases); purchasesControlsWired = true; }
        function renderPurchaseSkeleton() { /* ... */ if (!purchasesTableBody) return; let s = ''; for (let i = 0; i < 3; i++)s += `<tr><td colspan="7"><div class="skeleton my-2" style="height:20px"></div></td></tr>`; purchasesTableBody.innerHTML = s; }
        async function loadPurchases() { /* ... */
            renderPurchaseSkeleton();
            purchasesData = await apiFetch(`${API_URL}/purchases`); // Propagates error
            purchasesData = Array.isArray(purchasesData) ? purchasesData.slice().sort((a, b) => (a?.PurchaseID || 0) - (b?.PurchaseID || 0)) : [];
            purchasesFiltered = purchasesData;
            wirePurchasesControls();
            renderPurchases();
        }
        function filterPurchases() {
            const q = document.getElementById('purchasesSearch')?.value?.toLowerCase() || '';
            purchasesFiltered = purchasesData.filter(p =>
                String(p.PurchaseID || '').includes(q) ||
                (p.ProductName || '').toLowerCase().includes(q) ||
                (p.SupplierName || '').toLowerCase().includes(q)
            );
            renderPurchases();
        }
        function renderPurchases() {
            if (!purchasesTableBody) return;
            if (purchasesFiltered.length === 0) { purchasesTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No purchases recorded.</td></tr>'; return; }
            let t = ''; purchasesFiltered.forEach(p => { let d = 'Invalid'; try { d = new Date(p.PurchaseDate).toLocaleString(); } catch (e) { } t += `<tr><td>${p.PurchaseID}</td><td>${p.ProductName || 'N/A'}</td><td>${p.SupplierName || 'N/A'}</td><td>${p.QuantityPurchased}</td><td>${formatCurrency(p.UnitCost)}</td><td>${formatCurrency(p.TotalCost)}</td><td>${d}</td></tr>`; }); purchasesTableBody.innerHTML = t;
        }
        async function openPurchaseModal() { /* ... */ const f = document.getElementById('purchaseForm'); if (!f) return; f.reset(); const pS = document.getElementById('purchaseProduct'), sS = document.getElementById('purchaseSupplier'); pS.innerHTML = '<option value="">Loading...</option>'; sS.innerHTML = '<option value="">Loading...</option>'; const m = document.getElementById('purchaseModal'); bootstrap.Modal.getOrCreateInstance(m).show(); try { await Promise.all([loadProductDropdown('purchaseProduct', false), loadSupplierDropdown('purchaseSupplier')]); } catch (e) { showToast("Error loading form data.", "error"); pS.innerHTML = '<option value="">Error</option>'; sS.innerHTML = '<option value="">Error</option>'; } }
        async function savePurchase() { /* ... */
            const f = document.getElementById('purchaseForm'); const pV = document.getElementById('purchaseProduct').value, sV = document.getElementById('purchaseSupplier').value, qV = parseInt(document.getElementById('purchaseQuantity').value), costV = parseFloat(document.getElementById('purchaseCost').value); if (!f.checkValidity() || !pV || !sV || qV <= 0 || costV <= 0) { f.reportValidity(); showToast('Select product, supplier, valid qty/cost > 0.', 'warning'); return; } const d = { ProductID: parseInt(pV), SupplierID: parseInt(sV), QuantityPurchased: qV, UnitCost: costV }; const b = document.querySelector('#purchaseModal .btn-primary'); const o = b.innerHTML; b.disabled = true; b.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Saving...`; try { await apiFetch(`${API_URL}/purchases`, { method: 'POST', body: d }); bootstrap.Modal.getInstance(document.getElementById('purchaseModal')).hide(); showToast('Purchase recorded!', 'success'); await loadPurchases(); if (document.getElementById('dashboard-section').classList.contains('active')) await loadDashboard(); if (document.getElementById('products-section').classList.contains('active')) await loadProducts(); } catch (e) { showToast(`Save failed: ${e.message}`, 'error'); } finally { b.disabled = false; b.innerHTML = o; }
        }

        // --- Reports ---
        async function loadReport(reportType) {
            const contentDiv = document.getElementById('reportContent');
            const titleEl = document.getElementById('reportTitle');
            const summaryRow = document.getElementById('reportSummary');
            const chartTypeSel = document.getElementById('reportChartType');
            const fromWrap = document.getElementById('reportFromWrap');
            const toWrap = document.getElementById('reportToWrap');
            const fromEl = document.getElementById('reportFrom');
            const toEl = document.getElementById('reportTo');
            if (!contentDiv || !titleEl) return;

            contentDiv.innerHTML = `<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            titleEl.textContent = 'Loading Report...';

            document.querySelectorAll('#reports-section .btn-outline-primary').forEach(b => b.classList.remove('active'));
            const activeButton = document.querySelector(`#reports-section .btn[onclick="loadReport('${reportType}')"]`);
            if (activeButton) activeButton.classList.add('active');

            try {
                let url, title, chartType = 'bar', chartOptions = {};
                switch (reportType) {
                    case 'TopProducts': url = `${API_URL}/reports/top-products`; title = 'Top Selling Products (Top 10)'; chartType = 'bar'; break;
                    case 'LowStock': url = `${API_URL}/reports/low-stock`; title = 'Low Stock Products'; chartType = 'bar'; chartOptions = { indexAxis: 'y', plugins: { legend: { display: false } } }; break;
                    case 'SalesSummary': url = `${API_URL}/reports/sales-summary`; title = 'Daily Sales Summary (Last 30 Days)'; chartType = 'line'; chartOptions = { scales: { x: { reverse: true } } }; break;
                    default: throw new Error(`Unknown report type: ${reportType}`);
                }

                const data = await apiFetch(url); // Propagates error
                titleEl.textContent = title;

                // Toggle date inputs for SalesSummary
                const showDate = reportType === 'SalesSummary';
                if (fromWrap) fromWrap.classList.toggle('d-none', !showDate);
                if (toWrap) toWrap.classList.toggle('d-none', !showDate);

                if (!Array.isArray(data) || data.length === 0) {
                    contentDiv.innerHTML = '<p class="text-muted text-center py-4">No data available for this report.</p>';
                    if (summaryRow) summaryRow.innerHTML = '';
                    if (reportChart) { reportChart.destroy(); reportChart = null; } return;
                }

                // Optional date filter for SalesSummary
                let filtered = data.slice();
                if (showDate && (fromEl?.value || toEl?.value)) {
                    const fromTime = fromEl?.value ? new Date(fromEl.value).getTime() : -Infinity;
                    const toTime = toEl?.value ? new Date(toEl.value).getTime() + 24 * 60 * 60 * 1000 - 1 : Infinity;
                    filtered = data.filter(d => { const t = new Date(d.SaleDate).getTime(); return t >= fromTime && t <= toTime; });
                }

                // Summary cards
                const card = (t, v, cls = 'primary') => (`<div class="col-6 col-lg-3"><div class="card border-0" style="background-color: var(--bs-${cls}-bg-subtle);"><div class="card-body"><div class="small text-${cls}-emphasis">${t}</div><div class="h5 fw-bold text-${cls}-emphasis">${v}</div></div></div></div>`);
                let summaryHTML = '';
                if (reportType === 'TopProducts') {
                    const totalUnits = filtered.reduce((s, r) => s + (Number(r.TotalSold) || 0), 0);
                    const revenue = filtered.reduce((s, r) => s + (Number(r.Revenue) || 0), 0);
                    summaryHTML = card('Products', filtered.length, 'primary') + card('Units Sold', totalUnits.toLocaleString(), 'success') + card('Revenue', formatCurrency(revenue), 'info');
                } else if (reportType === 'LowStock') {
                    const qtyNeeded = filtered.reduce((s, r) => s + (Number(r.QuantityNeeded) || 0), 0);
                    const lowest = Math.min(...filtered.map(r => Number(r.Quantity) || 0));
                    summaryHTML = card('Items Low', filtered.length, 'warning') + card('Qty Needed', qtyNeeded.toLocaleString(), 'danger') + card('Lowest Stock', (isFinite(lowest) ? lowest : 0).toLocaleString(), 'dark');
                } else if (reportType === 'SalesSummary') {
                    const total = filtered.reduce((s, r) => s + (Number(r.TotalAmount) || 0), 0);
                    const days = new Set(filtered.map(r => new Date(r.SaleDate).toDateString())).size || 1;
                    const avg = total / days;
                    summaryHTML = card('Days', days, 'primary') + card('Total Sales', formatCurrency(total), 'success') + card('Avg / Day', formatCurrency(avg), 'info');
                }
                if (summaryRow) summaryRow.innerHTML = summaryHTML;

                contentDiv.innerHTML = `
                    <div class="row g-3">
                         <div class="col-lg-6" style="min-height: 320px; height: 360px; position: relative;">
                              <canvas id="reportChart"></canvas>
                         </div>
                         <div class="col-lg-6">
                              <div class="table-responsive" style="max-height: 400px;">
                                   <table class="table table-sm table-striped table-hover align-middle mb-0" id="reportTable"></table>
                              </div>
                         </div>
                    </div>`;

                // Build table from filtered
                let tableHTML = '<thead><tr>'; const headers = Object.keys(filtered[0]); headers.forEach(key => tableHTML += `<th>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</th>`); tableHTML += '</tr></thead><tbody>';
                filtered.forEach(row => { tableHTML += '<tr>'; headers.forEach(key => { let v = row[key], c = v ?? 'N/A'; if (key.match(/amount|price|cost|revenue|sales/i) && typeof v === 'number') c = formatCurrency(v); else if (key.match(/date/i)) try { c = new Date(v).toLocaleDateString(); } catch (e) { } else if (key === 'Quantity' && reportType === 'LowStock') c = `<span class="badge bg-danger">${v}</span>`; tableHTML += `<td>${c}</td>`; }); tableHTML += '</tr>'; }); tableHTML += '</tbody>';
                const reportTableEl = document.getElementById('reportTable'); if (reportTableEl) reportTableEl.innerHTML = tableHTML;

                // Chart rendering
                const ctx = document.getElementById('reportChart')?.getContext('2d');
                if (ctx) {
                    const isDark = document.body.getAttribute('data-theme') === 'dark';
                    const pC = isDark ? 'rgba(138,180,248,0.75)' : 'rgba(94,80,249,0.75)', sC = isDark ? 'rgba(45,212,191,0.65)' : 'rgba(6,214,160,0.65)', dC = isDark ? 'rgba(248,113,113,0.75)' : 'rgba(239,71,111,0.75)';
                    let chosenType = chartTypeSel?.value || chartType;
                    let chartData = { labels: [], datasets: [] };
                    if (reportType === 'TopProducts') {
                        const arr = filtered.slice(0, 10);
                        chartData.labels = arr.map(d => d.ProductName);
                        chartData.datasets = [{ label: 'Units Sold', data: arr.map(d => d.TotalSold), backgroundColor: pC }, { label: 'Revenue ()', data: arr.map(d => d.Revenue), backgroundColor: sC }];
                        if (chosenType === 'pie') { chartData = { labels: arr.map(d => d.ProductName), datasets: [{ data: arr.map(d => d.TotalSold), backgroundColor: arr.map((_, i) => i % 2 ? pC : sC) }] }; }
                    }
                    else if (reportType === 'LowStock') {
                        const arr = filtered.slice(0, 15);
                        chartData.labels = arr.map(d => d.ProductName);
                        chartData.datasets = [{ label: 'Quantity Needed', data: arr.map(d => d.QuantityNeeded), backgroundColor: dC }];
                        if (chosenType === 'pie') { chartData = { labels: arr.map(d => d.ProductName), datasets: [{ data: arr.map(d => d.QuantityNeeded), backgroundColor: arr.map((_, i) => i % 2 ? dC : pC) }] }; }
                    }
                    else if (reportType === 'SalesSummary') {
                        const sD = filtered.slice().sort((a, b) => new Date(a.SaleDate) - new Date(b.SaleDate));
                        chartData.labels = sD.map(d => new Date(d.SaleDate).toLocaleDateString());
                        chartData.datasets = [{ label: 'Sales ()', data: sD.map(d => d.TotalAmount), borderColor: pC, backgroundColor: pC.replace('0.75', '0.2'), tension: .35, fill: true }];
                        if (chosenType === 'pie') { chartData = { labels: ['Total'], datasets: [{ data: [sD.reduce((s, r) => s + (Number(r.TotalAmount) || 0), 0)], backgroundColor: [pC] }] }; }
                    }
                    renderChart(ctx, chosenType, chartData, chartOptions);
                } else console.error("Canvas element for chart not found.");

            } catch (error) {
                console.error(`Error loading report ${reportType}:`, error);
                titleEl.textContent = `Error Loading ${reportType}`;
                contentDiv.innerHTML = `<p class="text-danger text-center py-4">Failed to load report data: ${error.message}</p>`;
                if (reportChart) { reportChart.destroy(); reportChart = null; }
            }
        }

        function exportTableToCSV(filename = 'report.csv') {
            const table = document.getElementById('reportTable'); if (!table) return;
            const rows = Array.from(table.querySelectorAll('tr'));
            const csv = rows.map(tr => Array.from(tr.querySelectorAll('th,td')).map(td => '"' + String(td.textContent).replace(/"/g, '""') + '"').join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = filename; link.click(); URL.revokeObjectURL(link.href);
        }

        // Initialize on DOMContentLoaded
        window.addEventListener('DOMContentLoaded', () => {
            // Theme handled by IIFE

            // Auth + initial data
            const navUser = document.getElementById('navUserLabel');
            const userMenu = document.getElementById('userMenu');
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                // Try server-side logout (best-effort)
                try { await apiFetch(`${API_URL}/logout`, { method: 'POST' }); } catch (_) { }
                clearAuth();
                if (userMenu) userMenu.classList.add('d-none');
                showToast('Logged out.', 'success');
                try { window.location.href = '/'; } catch { }
            });

            // Profile/Settings modals wiring
            function getSettings() {
                try { return JSON.parse(localStorage.getItem('appSettings') || '{}'); } catch { return {}; }
            }
            function setSettings(obj) {
                try { localStorage.setItem('appSettings', JSON.stringify(obj || {})); } catch { }
            }
            function getProfile() {
                try { return JSON.parse(localStorage.getItem('appProfile') || '{}'); } catch { return {}; }
            }
            function setProfile(obj) {
                try { localStorage.setItem('appProfile', JSON.stringify(obj || {})); } catch { }
            }

            const openProfile = document.getElementById('openProfile');
            const openSettings = document.getElementById('openSettings');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');

            if (openProfile) openProfile.addEventListener('click', (e) => {
                e.preventDefault();
                const p = getProfile();
                const u = getAuthUser();
                document.getElementById('profileUsername').value = u;
                document.getElementById('profileEmail').value = p.email || '';
                document.getElementById('profileFullName').value = p.fullName || '';
                document.getElementById('profileBio').value = p.bio || '';
                bootstrap.Modal.getOrCreateInstance(document.getElementById('profileModal')).show();
            });
            if (saveProfileBtn) saveProfileBtn.addEventListener('click', () => {
                const p = {
                    email: document.getElementById('profileEmail').value.trim(),
                    fullName: document.getElementById('profileFullName').value.trim(),
                    bio: document.getElementById('profileBio').value.trim()
                };
                setProfile(p);
                bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
                showToast('Profile saved', 'success');
            });

            if (openSettings) openSettings.addEventListener('click', (e) => {
                e.preventDefault();
                const s = getSettings();
                document.getElementById('setPageSize').value = String(s.pageSize || 10);
                document.getElementById('setChartType').value = s.chartType || 'bar';
                document.getElementById('setDarkMode').checked = (localStorage.getItem('theme') || 'light') === 'dark';
                bootstrap.Modal.getOrCreateInstance(document.getElementById('settingsModal')).show();
            });
            if (saveSettingsBtn) saveSettingsBtn.addEventListener('click', () => {
                const s = getSettings();
                const newS = {
                    ...s,
                    pageSize: parseInt(document.getElementById('setPageSize').value) || 10,
                    chartType: document.getElementById('setChartType').value
                };
                setSettings(newS);
                // Apply immediately
                const desiredTheme = document.getElementById('setDarkMode').checked ? 'dark' : 'light';
                const currentTheme = document.body.getAttribute('data-theme');
                if (desiredTheme !== currentTheme) {
                    const themeBtn = document.getElementById('themeToggle');
                    themeBtn?.click();
                }
                // If products page is active, re-render with new page size
                const pageSizeSel = document.getElementById('productPageSize');
                if (pageSizeSel) { pageSizeSel.value = String(newS.pageSize); }
                bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
                showToast('Settings saved', 'success');
            });

            const token = getAuthToken();
            if (!token) {
                try { window.location.href = '/'; return; } catch { }
            } else {
                if (navUser) navUser.textContent = getAuthUser();
                if (userMenu) userMenu.classList.remove('d-none');
                loadDashboard().catch(err => {
                    console.error("Initial dashboard load failed:", err);
                    showToast(`Failed to load initial dashboard: ${err.message}`, "error");
                    const dashSection = document.getElementById('dashboard-section');
                    if (dashSection) dashSection.innerHTML = `<p class="text-danger text-center py-5">Could not load dashboard data. Please refresh the page.</p>`;
                });
            }

            // Load Chart.js script dynamically if not already loaded
            if (typeof Chart === 'undefined' && !document.querySelector('script[src*="chart.umd.min.js"]')) {
                const chartScript = document.createElement('script');
                chartScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js';
                chartScript.async = true;
                chartScript.onload = () => console.log("Chart.js loaded.");
                chartScript.onerror = () => console.error("Failed to load Chart.js");
                document.body.appendChild(chartScript);
            }

            // Enable Bootstrap tooltips (safer initialization)
            try {
                // Initialize tooltips only on elements that don't already have one initialized
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]:not([disabled]):not([data-bs-original-title])'));
                tooltipTriggerList.forEach(tooltipTriggerEl => {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                });
            } catch (e) { console.warn("Error initializing tooltips:", e); }

            // Navbar shadow on scroll
            const nav = document.querySelector('.navbar');
            const onScroll = () => {
                if (!nav) return;
                if (window.scrollY > 4) nav.classList.add('scrolled'); else nav.classList.remove('scrolled');
            };
            onScroll();
            window.addEventListener('scroll', onScroll, { passive: true });

            // Sidebar off-canvas toggle (mobile)
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebar && sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('open');
                });
                // Close sidebar when clicking outside (mobile)
                document.addEventListener('click', (e) => {
                    if (window.innerWidth >= 992) return; // only mobile
                    if (!sidebar.classList.contains('open')) return;
                    const withinSidebar = sidebar.contains(e.target);
                    const isToggle = sidebarToggle.contains(e.target);
                    if (!withinSidebar && !isToggle) sidebar.classList.remove('open');
                });
            }

            // Export button
            const exportBtn = document.getElementById('exportReportBtn');
            if (exportBtn) exportBtn.addEventListener('click', () => exportTableToCSV());

            // Re-render when chart type changes or date changes
            const chartTypeSel = document.getElementById('reportChartType');
            if (chartTypeSel) chartTypeSel.addEventListener('change', () => {
                const active = document.querySelector('#reports-section .btn-outline-primary.active');
                const match = active?.getAttribute('onclick')?.match(/loadReport\('([^']+)'\)/);
                if (match && match[1]) loadReport(match[1]);
            });
            const fromEl = document.getElementById('reportFrom');
            const toEl = document.getElementById('reportTo');
            [fromEl, toEl].forEach(el => el?.addEventListener('change', () => {
                const active = document.querySelector('#reports-section .btn-outline-primary.active');
                const match = active?.getAttribute('onclick')?.match(/loadReport\('([^']+)'\)/);
                if (match && match[1]) loadReport(match[1]);
            }));

            // Real-time validation for all relevant fields
            const attachValidation = (el) => {
                if (!el) return;
                const validate = () => {
                    // Empty fields: no state until user enters something
                    const val = (el.value || '').trim();
                    if (val === '') { el.classList.remove('is-valid', 'is-invalid'); return; }
                    if (!el.checkValidity()) { el.classList.add('is-invalid'); el.classList.remove('is-valid'); }
                    else { el.classList.add('is-valid'); el.classList.remove('is-invalid'); }
                };
                el.addEventListener('input', validate);
                el.addEventListener('blur', validate);
                if (el.tagName === 'SELECT') el.addEventListener('change', validate);
            };
            document.querySelectorAll('#productForm input, #productForm textarea, #productForm select,\
                                       #supplierForm input, #supplierForm textarea, #supplierForm select,\
                                       #customerForm input, #customerForm textarea, #customerForm select,\
                                       #saleForm input, #saleForm select,\
                                       #purchaseForm input, #purchaseForm select')
                .forEach(attachValidation);
            // Phone validation (country-aware)
            const digitsOnly = (v) => (v || '').replace(/\D/g, '');
            const attachPhoneValidation = (codeId, inputId, feedbackId) => {
                const codeEl = document.getElementById(codeId);
                const inputEl = document.getElementById(inputId);
                const feedbackEl = document.getElementById(feedbackId);
                if (!codeEl || !inputEl) return;
                const validate = () => {
                    const len = parseInt(codeEl.selectedOptions?.[0]?.dataset?.len || '10');
                    const digits = digitsOnly(inputEl.value);
                    inputEl.value = digits; // keep numeric only
                    if (digits.length === 0) { inputEl.classList.remove('is-valid', 'is-invalid'); return; }
                    if (digits.length !== len) {
                        inputEl.classList.add('is-invalid'); inputEl.classList.remove('is-valid');
                        if (feedbackEl) feedbackEl.textContent = `Enter ${len} digits for ${codeEl.value}.`;
                    } else { inputEl.classList.add('is-valid'); inputEl.classList.remove('is-invalid'); }
                };
                inputEl.addEventListener('input', validate);
                inputEl.addEventListener('blur', validate);
                codeEl.addEventListener('change', validate);
            };
            attachPhoneValidation('supplierPhoneCode', 'supplierPhone', 'supplierPhoneFeedback');
            attachPhoneValidation('customerPhoneCode', 'customerPhone', 'customerPhoneFeedback');
            // Login handlers removed (using standalone login page)

        });

    </script>
</body>

</html>